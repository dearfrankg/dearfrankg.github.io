<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
    <title>dev notes</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/gitment.css">
    <link rel="stylesheet" href="/css/font_859455_eaq7v6w8ktj.css">
</head>

<body>
<header class="header">
    <div class="header-inner">
        <div class="header-title">

        </div>
        <nav class="header-nav">
            
            <a href="/" class="header-nav-link">
                Home
            </a>
            

            
            <a href="/archives" class="header-nav-link">
                Archives
            </a>
            

            
            <a href="/tags" class="header-nav-link">
                Tags
            </a>
            

            
        </nav>
    </div>
</header>
<header class="mobile-header">
    <div class="mobile-nav">
        <div class="mobile-nav-icon">
            <span></span>
            <span></span>
            <span></span>
        </div>
        <div class="mobile-nav-title">
            <a href="/" class="mobile-nav-title-link">Frank Gutierrez's Blog</a>
        </div>

    </div>
    <nav class="mobile-menu">
        <ul class="mobile-menu-list">
            <li class="mobile-menu-item">
                <i class="iconfont icon-home"></i>
                <a href="/" class="mobile-nav-link">Home</a>
            </li>
            <li class="mobile-menu-item">
                <i class="iconfont icon-archive"></i>
                <a href="/archives" class="mobile-nav-link">Archives</a>
            </li>
            <li class="mobile-menu-item">
                <i class="iconfont icon-tag"></i>
                <a href="/tags" class="mobile-nav-link">Tags</a>
            </li>
            <li class="mobile-menu-item">
                <i class="iconfont icon-about"></i>
                <a href="/about/" class="mobile-nav-link">About</a>
            </li>
        </ul>
    </nav>
</header>
<div class="main">
    <div class="content-inner">
        <div class="posts">
    <article class="post-whole">
        <div class="post-title">
            <h2 class="title">Frisby&#39;s Mostly Adequate Guide to Functional Programming - Part 2</h2>
            <div class="post-meta">
                <span class="post-time">2016-08-10</span>
                
                <span class="post-visit"> visited：<span id="busuanzi_value_page_pv"></span></span>
            </div>
        </div>
        <div class="post-toc" id="post-toc">
    <strong class="post-toc-title">TOC</strong>
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Introduction"><span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Functors"><span class="toc-text">Functors</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#The-Mighty-Container"><span class="toc-text">The Mighty Container</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Your-First-Functor"><span class="toc-text">Your First Functor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Schrodinger’s-Maybe"><span class="toc-text">Schrödinger’s Maybe</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#maintaining-our-pointfree-style"><span class="toc-text">maintaining our pointfree style</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Use-Cases"><span class="toc-text">Use Cases</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Releasing-the-value"><span class="toc-text">Releasing the value</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pure-Error-Handling"><span class="toc-text">Pure Error Handling</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Lifting"><span class="toc-text">Lifting</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#side-effects"><span class="toc-text">side-effects</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Asynchronous-Tasks"><span class="toc-text">Asynchronous Tasks</span></a></li></ol></li></ol>
    <div class="back-to-top" id="back-to-top">
        <a href="javascript:void(0);">back to top</a>
    </div>
</div>

        <div class="post-content">
            <!-- TOC depthFrom:1 depthTo:3 withLinks:1 updateOnSave:1 orderedList:0 -->
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#functors">Functors</a><ul>
<li><a href="#the-mighty-container">The Mighty Container</a></li>
<li><a href="#your-first-functor">Your First Functor</a></li>
<li><a href="#schr%C3%B6dingers-maybe">Schrödinger’s Maybe</a></li>
<li><a href="#maintaining-our-pointfree-style">maintaining our pointfree style</a></li>
<li><a href="#use-cases">Use Cases</a></li>
<li><a href="#releasing-the-value">Releasing the value</a></li>
<li><a href="#pure-error-handling">Pure Error Handling</a></li>
<li><a href="#lifting">Lifting</a></li>
<li><a href="#side-effects">side-effects</a></li>
<li><a href="#asynchronous-tasks">Asynchronous Tasks</a></li>
</ul>
</li>
</ul>
<!-- /TOC -->
<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>This is Part 2 of a series on Functional Programming. See <a href="">Part 1</a></p>
<h2 id="Functors"><a href="#Functors" class="headerlink" title="Functors"></a>Functors</h2><p>To handle <code>control flow</code>, <code>error handling</code>, <code>asynchronous actions</code>, <code>state</code> and <code>effects</code>, we will discover the foundation upon which all of these helpful abstractions are built.</p>
<h3 id="The-Mighty-Container"><a href="#The-Mighty-Container" class="headerlink" title="The Mighty Container"></a>The Mighty Container</h3><ul>
<li>Container is an object with one property.</li>
<li>The <code>__value</code> cannot be one specific type.</li>
<li>Once data goes into the Container it stays there.</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Container = <span class="function"><span class="keyword">function</span>(<span class="params">x</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.__value = x;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Container.of = <span class="function"><span class="params">x</span> =&gt;</span> <span class="keyword">new</span> Container(x);</span><br><span class="line"></span><br><span class="line">Container.of(<span class="number">3</span>);</span><br><span class="line"><span class="comment">//=&gt; Container(3)</span></span><br></pre></td></tr></table></figure>
<h3 id="Your-First-Functor"><a href="#Your-First-Functor" class="headerlink" title="Your First Functor"></a>Your First Functor</h3><ul>
<li>We run functions on the data using a <code>map</code> method.</li>
</ul>
<blockquote>
<p>A Functor is a type that implements map and obeys some laws</p>
</blockquote>
<p>What we gain from asking our container to apply functions for us is, <code>abstraction of function application</code>. When we map a function, we ask the container type to run it for us.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// (a -&gt; b) -&gt; Container a -&gt; Container b</span></span><br><span class="line">Container.prototype.map = <span class="function"><span class="keyword">function</span>(<span class="params">f</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> Container.of(f(<span class="keyword">this</span>.__value));</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Container.of(<span class="string">"flamethrowers"</span>).map(<span class="function"><span class="params">s</span> =&gt;</span> s.toUpperCase());</span><br><span class="line"><span class="comment">//=&gt; Container("FLAMETHROWERS")</span></span><br></pre></td></tr></table></figure>
<p>Functors come from category theory and we’ll look at the maths in detail toward the end of the chapter.</p>
<h3 id="Schrodinger’s-Maybe"><a href="#Schrodinger’s-Maybe" class="headerlink" title="Schrödinger’s Maybe"></a>Schrödinger’s Maybe</h3><p>The <code>Maybe</code> functor checks to see if it has a value before calling the supplied function. This has the effect of side stepping those pesky nulls as we map (Note that this implementation is simplified for teaching).</p>
<figure class="highlight js"><figcaption><span>define and apply Maybe</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Maybe = <span class="function"><span class="keyword">function</span>(<span class="params">x</span>) </span>&#123; <span class="keyword">this</span>.__value = x &#125;</span><br><span class="line"></span><br><span class="line">Maybe.of = <span class="function"><span class="keyword">function</span> (<span class="params">x</span>) =&gt; <span class="title">new</span> <span class="title">Maybe</span>(<span class="params">x</span>)</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Maybe</span>.<span class="title">prototype</span>.<span class="title">isNothing</span> = <span class="title">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.__value === <span class="literal">null</span> || <span class="keyword">this</span>.__value === <span class="literal">undefined</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Maybe.prototype.map = <span class="function"><span class="keyword">function</span> (<span class="params">f</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.isNothing() ? Maybe.of(<span class="literal">null</span>) : Maybe.of(f(<span class="keyword">this</span>.__value)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Maybe.of(&#123; <span class="attr">name</span>: <span class="string">'Boris'</span> &#125;).map(_.prop(<span class="string">'age'</span>)).map(add(<span class="number">10</span>))</span><br><span class="line"><span class="comment">//=&gt; Maybe(null)</span></span><br><span class="line"></span><br><span class="line">Maybe.of(&#123; <span class="attr">name</span>: <span class="string">'Dinah'</span>, <span class="attr">age</span>: <span class="number">14</span>, &#125;).map(_.prop(<span class="string">'age'</span>)).map(add(<span class="number">10</span>))</span><br><span class="line"><span class="comment">//=&gt; Maybe(24)</span></span><br></pre></td></tr></table></figure>
<h3 id="maintaining-our-pointfree-style"><a href="#maintaining-our-pointfree-style" class="headerlink" title="maintaining our pointfree style"></a>maintaining our pointfree style</h3><p>This dot syntax is perfectly fine and functional, but we’d like to maintain our pointfree style. This <code>map</code> function is fully equipped to delegate to whatever functor it receives:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  map :: Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b</span></span><br><span class="line"><span class="keyword">var</span> map = curry(<span class="function"><span class="keyword">function</span>(<span class="params">f, any_functor_at_all</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> any_functor_at_all.map(f);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>This way we can carry on with composition per usual and map will work as expected. This is the case with <code>ramda</code>‘s map as well. We’ll use dot notation when it’s instructive and the pointfree version when it’s convenient. I’ve introduced extra notation into our type signature. In the signature, the <code>Functor f =&gt;</code> tells us that <code>f</code> must be a Functor.</p>
<h3 id="Use-Cases"><a href="#Use-Cases" class="headerlink" title="Use Cases"></a>Use Cases</h3><p><code>Maybe</code> can be used in functions that might otherwise fail to return a result.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  safeHead :: [a] -&gt; Maybe(a)</span></span><br><span class="line"><span class="keyword">var</span> safeHead = <span class="function"><span class="params">xs</span> =&gt;</span> Maybe.of(xs[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> streetName = compose(</span><br><span class="line">  map(_.prop(<span class="string">"street"</span>)),</span><br><span class="line">  safeHead,</span><br><span class="line">  _.prop(<span class="string">"addresses"</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">streetName(&#123; <span class="attr">addresses</span>: [] &#125;);</span><br><span class="line"><span class="comment">// Maybe(null)</span></span><br><span class="line"></span><br><span class="line">streetName(&#123;</span><br><span class="line">  addresses: [</span><br><span class="line">    &#123;</span><br><span class="line">      street: <span class="string">"Shady Ln."</span>,</span><br><span class="line">      number: <span class="number">4201</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// Maybe("Shady Ln.")</span></span><br></pre></td></tr></table></figure>
<p><code>Maybe</code> can be used to explicitly signal failure.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  withdraw :: Number -&gt; Account -&gt; Maybe(Account)</span></span><br><span class="line"><span class="keyword">const</span> withdraw = curry(<span class="function">(<span class="params">amount, account</span>) =&gt;</span></span><br><span class="line">   account.balance &gt;= amount</span><br><span class="line">    ? Maybe.of(&#123; <span class="attr">balance</span>: account.balance - amount &#125;)</span><br><span class="line">    : Maybe.of(<span class="literal">null</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">//  finishTransaction :: Account -&gt; String</span></span><br><span class="line"><span class="keyword">const</span> finishTransaction = compose(remainingBalance, updateLedger)</span><br><span class="line"><span class="comment">// &lt;- these composed functions are hypothetical, not implemented here...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//  getTwenty :: Account -&gt; Maybe(String)</span></span><br><span class="line"><span class="keyword">const</span> getTwenty = compose(map(finishTransaction), withdraw(<span class="number">20</span>))</span><br><span class="line"></span><br><span class="line">getTwenty(&#123; <span class="attr">balance</span>: <span class="number">200.00</span> &#125;)</span><br><span class="line"><span class="comment">// Maybe("Your balance is $180.00")</span></span><br><span class="line"></span><br><span class="line">getTwenty(&#123; <span class="attr">balance</span>: <span class="number">10.00</span> &#125;)</span><br><span class="line"><span class="comment">// Maybe(null)</span></span><br></pre></td></tr></table></figure>
<p>It is important to note: if the <code>withdraw</code> fails, then <code>map</code> will sever the rest of our computation since it doesn’t ever run the mapped functions, namely <code>finishTransaction</code>. This is precisely the intended behavior as we’d prefer not to update our ledger or show a new balance if we hadn’t successfully withdrawn funds.</p>
<h3 id="Releasing-the-value"><a href="#Releasing-the-value" class="headerlink" title="Releasing the value"></a>Releasing the value</h3><p>One thing people often miss is that there will always be an end of the line some effecting function that sends JSON along, or prints to the screen, or alters our filesystem, or what have you. We cannot deliver the output with <code>return</code>, we must run some function or another to send it out into the world.</p>
<p>Our application’s job is to retrieve, transform, and carry that data along until it’s time to say goodbye and the function which does so may be mapped, thus the value needn’t leave the warm womb of its container. Indeed, a common error is to try to remove the value from our <code>Maybe</code> one way or another as if the possible value inside will suddenly materialize and all will be forgiven. We must understand it may be a branch of code where our value is not around to live up to its destiny. Our code, much like Schrödinger’s cat, is in two states at once and should maintain that fact until the final function. This gives our code a linear flow despite the logical branching.</p>
<p>There is a little helper called <code>maybe</code> that will return a custom value and continue on.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  maybe :: b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b</span></span><br><span class="line"><span class="keyword">var</span> maybe = curry(<span class="function"><span class="keyword">function</span>(<span class="params">x, f, m</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> m.isNothing() ? x : f(m.__value);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//  getTwenty :: Account -&gt; String</span></span><br><span class="line"><span class="keyword">var</span> getTwenty = compose(maybe(<span class="string">"You're broke!"</span>, finishTransaction, withdraw(<span class="number">20</span>)));</span><br><span class="line"></span><br><span class="line">getTwenty(&#123; <span class="attr">balance</span>: <span class="number">200.0</span> &#125;);</span><br><span class="line"><span class="comment">// "Your balance is $180.00"</span></span><br><span class="line"></span><br><span class="line">getTwenty(&#123; <span class="attr">balance</span>: <span class="number">10.0</span> &#125;);</span><br><span class="line"><span class="comment">// "You're broke!"</span></span><br></pre></td></tr></table></figure>
<p>With <code>maybe</code>, we are witnessing the equivalent of an <code>if/else</code> statement whereas with <code>map</code>, the imperative analog would be: <code>if (x !== null) { return f(x) }</code>.</p>
<p>When pushed to deal with null checks all the time most people can’t help, but feel it’s a tad laborious. However, with time, it will become second nature and you’ll likely appreciate the safety.</p>
<p>I’d be remiss if I didn’t mention that the “real” implementation will split <code>Maybe</code> into two types: one for <code>something</code> and the other for <code>nothing</code>. This allows us to obey parametricity in map so values like null and undefined can still be mapped over and the universal qualification of the value in a functor will be respected. You’ll often see types like <code>Some(x) / None</code> or <code>Just(x) / Nothing</code> instead of a <code>Maybe</code> that does a null check on its value.</p>
<h3 id="Pure-Error-Handling"><a href="#Pure-Error-Handling" class="headerlink" title="Pure Error Handling"></a>Pure Error Handling</h3><p>It may come as a shock, but <code>throw/catch</code> is not very pure. With our new friend <code>Either</code>, we can respond with a polite message.</p>
<p><code>Left</code> and <code>Right</code> are two subclasses of an abstract type we call <code>Either</code>. I’ve skipped the ceremony of creating the <code>Either</code> superclass as we won’t ever use it, but it’s good to be aware. Let’s see how they act:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Left = <span class="function"><span class="keyword">function</span>(<span class="params">x</span>) </span>&#123; <span class="keyword">this</span>.__value = x &#125;</span><br><span class="line"></span><br><span class="line">Left.of = <span class="function">(<span class="params">x</span>) =&gt;</span> <span class="keyword">new</span> Left(x)</span><br><span class="line"></span><br><span class="line">Left.prototype.map = <span class="function"><span class="keyword">function</span> (<span class="params">f</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> Right = <span class="function"><span class="keyword">function</span>(<span class="params">x</span>) </span>&#123; <span class="keyword">this</span>.__value = x &#125;</span><br><span class="line"></span><br><span class="line">Right.of = <span class="function">(<span class="params">x</span>) =&gt;</span> <span class="keyword">new</span> Right(x)</span><br><span class="line"></span><br><span class="line">Right.prototype.map = <span class="function"><span class="keyword">function</span> (<span class="params">f</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> Right.of(f(<span class="keyword">this</span>.__value))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Right.of(<span class="string">'rain'</span>).map(<span class="function">(<span class="params">str</span>) =&gt;</span> <span class="string">'b'</span> + str)</span><br><span class="line"><span class="comment">// Right('brain')</span></span><br><span class="line"></span><br><span class="line">Left.of(<span class="string">'rain'</span>).map(<span class="function">(<span class="params">str</span>) =&gt;</span> <span class="string">'b'</span> + str</span><br><span class="line"><span class="comment">// Left('rain')</span></span><br><span class="line"></span><br><span class="line">Right.of(&#123;</span><br><span class="line">  host: <span class="string">'localhost'</span>,</span><br><span class="line">  port: <span class="number">80</span>,</span><br><span class="line">&#125;).map(_.prop(<span class="string">'host'</span>))</span><br><span class="line"><span class="comment">// Right('localhost')</span></span><br><span class="line"></span><br><span class="line">Left.of(<span class="string">'rolls eyes...'</span>).map(_.prop(<span class="string">'host'</span>))</span><br><span class="line"><span class="comment">// Left('rolls eyes...')</span></span><br></pre></td></tr></table></figure>
<p>Let’s use <code>Left</code> to find out more about a failure.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> moment = <span class="built_in">require</span>(<span class="string">"moment"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//  getAge :: Date -&gt; User -&gt; Either(String, Number)</span></span><br><span class="line"><span class="keyword">var</span> getAge = curry(<span class="function"><span class="keyword">function</span>(<span class="params">now, user</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> birthdate = moment(user.birthdate, <span class="string">"YYYY-MM-DD"</span>);</span><br><span class="line">  <span class="keyword">if</span> (!birthdate.isValid()) <span class="keyword">return</span> Left.of(<span class="string">"Birth date could not be parsed"</span>);</span><br><span class="line">  <span class="keyword">return</span> Right.of(now.diff(birthdate, <span class="string">"years"</span>));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">getAge(moment(), &#123; <span class="attr">birthdate</span>: <span class="string">"2005-12-12"</span> &#125;);</span><br><span class="line"><span class="comment">// Right(9)</span></span><br><span class="line"></span><br><span class="line">getAge(moment(), &#123; <span class="attr">birthdate</span>: <span class="string">"20010704"</span> &#125;);</span><br><span class="line"><span class="comment">// Left('Birth date could not be parsed')</span></span><br></pre></td></tr></table></figure>
<p>Something to notice is that we return <code>Either(String, Number)</code>, which holds a String as its Left value and a Number as its Right. This type signature is a bit informal as we haven’t taken the time to define an actual Either superclass, however, we learn a lot from the type. It informs us that we’re either getting an error message or the age back.</p>
<p>In this example, we are logically branching our control flow depending on the validity of the birth date, yet it reads as one linear motion from right to left rather than climbing through the curly braces of a conditional statement.</p>
<blockquote>
<p>FYI In some browsers you have to use <code>console.log.bind(console)</code> to use it first class</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  fortune :: Number -&gt; String</span></span><br><span class="line"><span class="keyword">var</span> fortune = compose(</span><br><span class="line">  concat(<span class="string">"If you survive, you will be "</span>),</span><br><span class="line">  add(<span class="number">1</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">//  zoltar :: User -&gt; Either(String, _)</span></span><br><span class="line"><span class="keyword">var</span> zoltar = compose(</span><br><span class="line">  map(<span class="built_in">console</span>.log),</span><br><span class="line">  map(fortune),</span><br><span class="line">  getAge(moment())</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">zoltar(&#123; <span class="attr">birthdate</span>: <span class="string">"2005-12-12"</span> &#125;);</span><br><span class="line"><span class="comment">// 'If you survive, you will be 10'</span></span><br><span class="line"><span class="comment">// Right(undefined)</span></span><br><span class="line"></span><br><span class="line">zoltar(&#123; <span class="attr">birthdate</span>: <span class="string">"balloons!"</span> &#125;);</span><br><span class="line"><span class="comment">// Left('Birth date could not be parsed')</span></span><br></pre></td></tr></table></figure>
<h3 id="Lifting"><a href="#Lifting" class="headerlink" title="Lifting"></a>Lifting</h3><p>At the time of calling, a function can be surrounded by map, which transforms it from a <code>non-functory</code> function to a <code>functory</code> one, in informal terms. We call this process lifting. Functions tend to be better off working with normal data types rather than container types, then lifted into the right container as deemed necessary. This leads to simpler, more reusable functions that can be altered to work with any functor on demand.</p>
<blockquote>
<p><code>Lifting</code> transforms a non-functory function to a functory one by surrounding it with map</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MAP</span></span><br><span class="line"><span class="comment">// map :: Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b</span></span><br><span class="line"><span class="comment">// var map = curry(function(f, any_functor_at_all) &#123;</span></span><br><span class="line"><span class="comment">//   return any_functor_at_all.map(f)</span></span><br><span class="line"><span class="comment">// &#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//  zoltar :: User -&gt; Either(String, _)</span></span><br><span class="line"><span class="keyword">var</span> zoltar = compose(</span><br><span class="line">  map(<span class="built_in">console</span>.log),</span><br><span class="line">  map(fortune),</span><br><span class="line">  getAge(moment())</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<ul>
<li><code>getAge(moment())</code> will return an <code>Either</code> resulting in a <code>Left</code> or <code>Right</code></li>
<li>onError: map(fortune) doesn’t process fortune function</li>
<li>onSuccess: map(fortune) does process fortune function</li>
<li>onError: map(console.log) does not print</li>
<li>onSuccess: map(console.log) prints <code>If you survive, you will be 10</code></li>
</ul>
<p><code>Either</code> is great for casual errors like validation as well as more serious, stop the show errors like missing files or broken sockets. Try replacing some of the <code>Maybe</code> examples with <code>Either</code> to give better feedback.</p>
<p>There are many things <code>Either</code> can be, but as a functor, it is used for its error handling.</p>
<p>Just like with <code>Maybe</code>, we have little <code>either</code>, which behaves similarly, but takes two functions instead of one and a static value. Each function should return the same type:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  either :: (a -&gt; c) -&gt; (b -&gt; c) -&gt; Either a b -&gt; c</span></span><br><span class="line"><span class="keyword">var</span> either = curry(<span class="function"><span class="keyword">function</span>(<span class="params">f, g, e</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (e.constructor) &#123;</span><br><span class="line">    <span class="keyword">case</span> Left:</span><br><span class="line">      <span class="keyword">return</span> f(e.__value);</span><br><span class="line">    <span class="keyword">case</span> Right:</span><br><span class="line">      <span class="keyword">return</span> g(e.__value);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//  zoltar :: User -&gt; _</span></span><br><span class="line"><span class="keyword">var</span> zoltar = compose(</span><br><span class="line">  <span class="built_in">console</span>.log,</span><br><span class="line">  either(id, fortune),</span><br><span class="line">  getAge(moment())</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">zoltar(&#123; <span class="attr">birthdate</span>: <span class="string">"2005-12-12"</span> &#125;);</span><br><span class="line"><span class="comment">// "If you survive, you will be 10"</span></span><br><span class="line"><span class="comment">// undefined</span></span><br><span class="line"></span><br><span class="line">zoltar(&#123; <span class="attr">birthdate</span>: <span class="string">"balloons!"</span> &#125;);</span><br><span class="line"><span class="comment">// "Birth date could not be parsed"</span></span><br><span class="line"><span class="comment">// undefined</span></span><br></pre></td></tr></table></figure>
<p>Finally, a use for that mysterious <code>id</code> function. It simply parrots back the value in the <code>Left</code> to pass the error message to console.log. We’ve made our fortune telling app more robust by enforcing error handling from within getAge.</p>
<h3 id="side-effects"><a href="#side-effects" class="headerlink" title="side-effects"></a>side-effects</h3><p>In our chapter about purity we saw a peculiar example of a pure function. This function contained a side-effect, but we dubbed it pure by wrapping its action in another function. Here’s another example of this:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  getFromStorage :: String -&gt; (_ -&gt; String)</span></span><br><span class="line"><span class="keyword">var</span> getFromStorage = <span class="function"><span class="keyword">function</span>(<span class="params">key</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> localStorage[key];</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>Had we not surrounded its guts in another function, getFromStorage would vary its output depending on external circumstance. With the sturdy wrapper in place, we will always get the same output per input: a function that, when called, will retrieve a particular item from localStorage. And just like that (maybe throw in a few Hail Mary’s) we’ve cleared our conscience and all is forgiven.</p>
<p>Except, this isn’t particularly useful now is it. Like a collectible action figure in its original packaging, we can’t actually play with it. If only there were a way to reach inside of the container and get at its contents… Enter <code>IO</code>.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> IO = <span class="function"><span class="keyword">function</span>(<span class="params">f</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.__value = f;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">IO.of = <span class="function"><span class="keyword">function</span>(<span class="params">x</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> IO(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> x;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">IO.prototype.map = <span class="function"><span class="keyword">function</span>(<span class="params">f</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> IO(</span><br><span class="line">    _.compose(</span><br><span class="line">      f,</span><br><span class="line">      <span class="keyword">this</span>.__value</span><br><span class="line">    )</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>IO</code> differs from the previous functors in that the <code>__value</code> is always a function. We don’t think of its <code>__value</code> as a function, however - that is an implementation detail and we best ignore it. What is happening is exactly what we saw with the <code>getFromStorage</code> example: <code>IO</code> delays the impure action by capturing it in a function wrapper. As such, we think of <code>IO</code> as containing the return value of the wrapped action and not the wrapper itself. This is apparent in the of function: we have an <code>IO(x)</code>, the <code>IO(function(){ return x })</code> is just necessary to avoid evaluation.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  io_window :: IO Window</span></span><br><span class="line"><span class="keyword">var</span> io_window = <span class="keyword">new</span> IO(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">window</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">io_window.map(<span class="function"><span class="keyword">function</span>(<span class="params">win</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> win.innerWidth;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// IO(1430)</span></span><br><span class="line"></span><br><span class="line">io_window</span><br><span class="line">  .map(_.prop(<span class="string">"location"</span>))</span><br><span class="line">  .map(_.prop(<span class="string">"href"</span>))</span><br><span class="line">  .map(_.split(<span class="string">"/"</span>));</span><br><span class="line"><span class="comment">// IO(["http:", "", "localhost:8000", "blog", "posts"])</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//  $ :: String -&gt; IO [DOM]</span></span><br><span class="line"><span class="keyword">var</span> $ = <span class="function"><span class="keyword">function</span>(<span class="params">selector</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> IO(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">document</span>.querySelectorAll(selector);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">$(<span class="string">"#myDiv"</span>)</span><br><span class="line">  .map(head)</span><br><span class="line">  .map(<span class="function"><span class="keyword">function</span>(<span class="params">div</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> div.innerHTML;</span><br><span class="line">  &#125;);</span><br><span class="line"><span class="comment">// IO('I am some inner html')</span></span><br></pre></td></tr></table></figure>
<p>Here, <code>io_window</code> is an actual <code>IO</code> that we can <code>map</code> over straight away, whereas <code>$</code> is a function that returns an <code>IO</code> after its called. I’ve written out the <em>conceptual</em> return values to better express the IO, though, in reality, it will always be <code>{ __value: [Function] }</code>. When we <code>map</code> over our <code>IO</code>, we stick that function at the end of a composition which, in turn, becomes the new <code>__value</code> and so on. Our mapped functions do not run, they get tacked on the end of a computation we’re building up, function by function, like carefully placing dominoes that we don’t dare tip over. The result is reminiscent of Gang of Four’s command pattern or a queue.</p>
<p>Take a moment to channel your functor intuition. If we see past the implementation details, we should feel right at home mapping over any container no matter its quirks or idiosyncrasies. We have the functor laws, which we will explore toward the end of the chapter, to thank for this pseudo-psychic power. At any rate, we can finally play with impure values without sacrificing our precious purity.</p>
<p>Mapping over our IO has built up a mighty impure computation and running it is surely going to disturb the peace. So where and when can we pull the trigger? If we put the onus on the calling code. Our pure code, despite the nefarious plotting and scheming, maintains its innocence and it’s the caller who gets burdened with the responsibility of actually running the effects. Let’s see an example to make this concrete.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">“<span class="comment">////// Our pure library: lib/params.js ///////</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//  url :: IO String</span></span><br><span class="line"><span class="keyword">var</span> url = <span class="keyword">new</span> IO(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">window</span>.location.href</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">//  toPairs =  String -&gt; [[String]]</span></span><br><span class="line"><span class="keyword">var</span> toPairs = compose(map(split(<span class="string">'='</span>)), split(<span class="string">'&amp;'</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">//  params :: String -&gt; [[String]]</span></span><br><span class="line"><span class="keyword">var</span> params = compose(toPairs, last, split(<span class="string">'?'</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">//  findParam :: String -&gt; IO Maybe [String]</span></span><br><span class="line"><span class="keyword">var</span> findParam = <span class="function"><span class="keyword">function</span>(<span class="params">key</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> map(compose(Maybe.of, filter(compose(eq(key), head)), params), url)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">////// Impure calling code: main.js ///////</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// run it by calling __value()!</span></span><br><span class="line">findParam(<span class="string">"searchTerm"</span>).__value()</span><br><span class="line"><span class="comment">// Maybe([['searchTerm', 'wafflehouse']])</span></span><br></pre></td></tr></table></figure>
<p>Our library keeps its hands clean by wrapping url in an IO and passing the buck to the caller. You might have also noticed that we have stacked our containers it’s perfectly reasonable to have a IO(Maybe([x])), which is three functors deep (Array is most definitely a mappable container type) and exceptionally expressive.</p>
<p>There’s something that’s been bothering me and we should rectify it immediately: IO’s __value isn’t really its contained value, nor is it a private property as the underscore prefix suggests. It is the pin in the grenade and it is meant to be pulled by a caller in the most public of ways. Let’s rename this property to unsafePerformIO to remind our users of its volatility.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> IO = <span class="function"><span class="keyword">function</span>(<span class="params">f</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.unsafePerformIO = f;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">IO.prototype.map = <span class="function"><span class="keyword">function</span>(<span class="params">f</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> IO(</span><br><span class="line">    _.compose(</span><br><span class="line">      f,</span><br><span class="line">      <span class="keyword">this</span>.unsafePerformIO</span><br><span class="line">    )</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>There, much better. Now our calling code becomes findParam(“searchTerm”).unsafePerformIO(), which is clear as day to users (and readers) of the application.</p>
<p>IO will be a loyal companion, helping us tame those feral impure actions. Next, we’ll see a type similar in spirit, but has a drastically different use case.</p>
<h3 id="Asynchronous-Tasks"><a href="#Asynchronous-Tasks" class="headerlink" title="Asynchronous Tasks"></a>Asynchronous Tasks</h3><p>Callbacks are the narrowing spiral staircase to hell. They are control flow as designed by M.C. Escher. With each nested callback squeezed in between the jungle gym of curly braces and parenthesis, they feel like limbo in an oubliette(how low can we go!). I’m getting claustrophobic chills just thinking about them. Not to worry, we have a much better way of dealing with asynchronous code and it starts with an “F”.</p>
<p>The internals are a bit too complicated to spill out all over the page here so we will use Data.Task (previously Data.Future) from Quildreen Motta’s fantastic Folktale. Behold some example usage:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Node readfile example:</span></span><br><span class="line"><span class="comment">//=======================</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//  readFile :: String -&gt; Task Error String</span></span><br><span class="line"><span class="keyword">var</span> readFile = <span class="function"><span class="keyword">function</span>(<span class="params">filename</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> Task(<span class="function"><span class="keyword">function</span>(<span class="params">reject, result</span>) </span>&#123;</span><br><span class="line">    fs.readFile(filename, <span class="string">'utf-8'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err, data</span>) </span>&#123;</span><br><span class="line">      err ? reject(err) : result(data);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">readFile(<span class="string">'metamorphosis'</span>).map(split(<span class="string">'\n'</span>)).map(head);</span><br><span class="line"><span class="comment">// Task("One morning, as Gregor Samsa was waking up from anxious dreams,</span></span><br><span class="line"><span class="comment">// he discovered that in bed he had been changed into a monstrous verminous bug.")</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// jQuery getJSON example:</span></span><br><span class="line"><span class="comment">//========================</span></span><br><span class="line"></span><br><span class="line">“<span class="comment">//  getJSON :: String -&gt; &#123;&#125; -&gt; Task Error JSON</span></span><br><span class="line"><span class="keyword">var</span> getJSON = curry(<span class="function"><span class="keyword">function</span>(<span class="params">url, params</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> Task(<span class="function"><span class="keyword">function</span>(<span class="params">reject, result</span>) </span>&#123;</span><br><span class="line">    $.getJSON(url, params, result).fail(reject);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">getJSON(<span class="string">'/video'</span>, &#123;</span><br><span class="line">  id: <span class="number">10</span>,</span><br><span class="line">&#125;).map(_.prop(<span class="string">'title'</span>));</span><br><span class="line"><span class="comment">// Task("Family Matters ep 15")</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// We can put normal, non futuristic values inside as well</span></span><br><span class="line">Task.of(<span class="number">3</span>).map(<span class="function"><span class="keyword">function</span>(<span class="params">three</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> three + <span class="number">1</span>,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// Task(4)</span></span><br></pre></td></tr></table></figure>
<p>The functions I’m calling reject and result are our error and success callbacks, respectively. As you can see, we simply map over the Task to work on the future value as if it was right there in our grasp. By now map should be old hat.</p>
<p>If you’re familiar with promises, you might recognize the function map as then with Task playing the role of our promise. Don’t fret if you aren’t familiar with promises, we won’t be using them anyhow because they are not pure, but the analogy holds nonetheless.</p>
<p>Like IO, Task will patiently wait for us to give it the green light before running. In fact, because it waits for our command, IO is effectively subsumed by Task for all things asynchronous; readFile and getJSON don’t require an extra IO container to be pure. What’s more, Task works in a similar fashion when we map over it: we’re placing instructions for the future like a chore chart in a time capsule - an act of sophisticated technological procrastination.</p>
<p>To run our Task, we must call the method fork. This works like unsafePerformIO, but as the name suggests, it will fork our process and evaluation continues on without blocking our thread. This can be implemented in numerous ways with threads and such, but here it acts as a normal async call would and the big wheel of the event loop keeps on turning. Let’s look at fork:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Pure application</span></span><br><span class="line"><span class="comment">//=====================</span></span><br><span class="line"><span class="comment">// blogTemplate :: String</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//  blogPage :: Posts -&gt; HTML</span></span><br><span class="line"><span class="keyword">var</span> blogPage = Handlebars.compile(blogTemplate);</span><br><span class="line"></span><br><span class="line"><span class="comment">//  renderPage :: Posts -&gt; HTML</span></span><br><span class="line"><span class="keyword">var</span> renderPage = compose(</span><br><span class="line">  blogPage,</span><br><span class="line">  sortBy(<span class="string">"date"</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">//  blog :: Params -&gt; Task Error HTML</span></span><br><span class="line"><span class="keyword">var</span> blog = compose(</span><br><span class="line">  map(renderPage),</span><br><span class="line">  getJSON(<span class="string">"/posts"</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Impure calling code</span></span><br><span class="line"><span class="comment">//=====================</span></span><br><span class="line">blog(&#123;&#125;).fork(</span><br><span class="line">  <span class="function"><span class="keyword">function</span>(<span class="params">error</span>) </span>&#123;</span><br><span class="line">    $(<span class="string">"#error"</span>).html(error.message);</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="function"><span class="keyword">function</span>(<span class="params">page</span>) </span>&#123;</span><br><span class="line">    $(<span class="string">"#main"</span>).html(page);</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">$(<span class="string">"#spinner"</span>).show();</span><br></pre></td></tr></table></figure>
<p>Upon calling fork, the Task hurries off to find some posts and render the page. Meanwhile, we show a spinner since fork does not wait for a response. Finally, we will either display an error or render the page onto the screen depending if the getJSON call succeeded or not.</p>
<p>Take a moment to consider how linear the control flow is here. We just read bottom to top, right to left even though the program will actually jump around a bit during execution. This makes reading and reasoning about our application simpler than having to bounce between callbacks and error handling blocks.</p>
<p>Goodness, would you look at that, Task has also swallowed up Either! It must do so in order to handle futuristic failures since our normal control flow does not apply in the async world. This is all well and good as it provides sufficient and pure error handling out of the box.</p>
<p>Even with Task, our IO and Either functors are not out of a job. Bear with me on a quick example that leans toward the more complex and hypothetical side, but is useful for illustrative purposes.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Postgres.connect :: Url -&gt; IO DbConnection</span></span><br><span class="line"><span class="comment">// runQuery :: DbConnection -&gt; ResultSet</span></span><br><span class="line"><span class="comment">// readFile :: String -&gt; Task Error String</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Pure application</span></span><br><span class="line"><span class="comment">//=====================</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//  dbUrl :: Config -&gt; Either Error Url</span></span><br><span class="line"><span class="keyword">var</span> dbUrl = <span class="function"><span class="keyword">function</span>(<span class="params">c</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> c.uname &amp;&amp; c.pass &amp;&amp; c.host &amp;&amp; c.db</span><br><span class="line">    ? Right.of(<span class="string">"db:pg://"</span> + c.uname + <span class="string">":"</span> + c.pass + <span class="string">"@"</span> + c.host + <span class="string">"5432/"</span> + c.db)</span><br><span class="line">    : Left.of(<span class="built_in">Error</span>(<span class="string">"Invalid config!"</span>));</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//  connectDb :: Config -&gt; Either Error (IO DbConnection)</span></span><br><span class="line"><span class="keyword">var</span> connectDb = compose(</span><br><span class="line">  map(Postgres.connect),</span><br><span class="line">  dbUrl</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">//  getConfig :: Filename -&gt; Task Error (Either Error (IO DbConnection))</span></span><br><span class="line"><span class="keyword">var</span> getConfig = compose(</span><br><span class="line">  map(</span><br><span class="line">    compose(</span><br><span class="line">      connectDb,</span><br><span class="line">      <span class="built_in">JSON</span>.parse</span><br><span class="line">    )</span><br><span class="line">  ),</span><br><span class="line">  readFile</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Impure calling code</span></span><br><span class="line"><span class="comment">//=====================</span></span><br><span class="line">getConfig(<span class="string">"db.json"</span>).fork(logErr(<span class="string">"couldn't read file"</span>), either(<span class="built_in">console</span>.log, map(runQuery)));</span><br></pre></td></tr></table></figure>
<p>In this example, we still make use of Either and IO from within the success branch of readFile. Task takes care of the impurities of reading a file asynchronously, but we still deal with validating the config with Either and wrangling the db connection with IO. So you see, we’re still in business for all things synchronous.</p>
<p>I could go on, but that’s all there is to it. Simple as map.</p>
<p>In practice, you’ll likely have multiple asynchronous tasks in one workflow and we haven’t yet acquired the full container APIs to tackle this scenario. Not to worry, we’ll look at monads and such soon, but first, we must examine the maths that make this all possible.</p>

        </div>
        
        <div class="post-tag">
            
            <a class="tag" href="/tags/javascript/" title="javascript">javascript</a>
            
            <a class="tag" href="/tags/functional/" title="functional">functional</a>
            
        </div>
        
    </article>
</div>
<div class="paginator">
    
        
            <a class="prev" href="/2016/08/18/20160828-Using-Oauth2/">
                <i class="iconfont icon-prev"></i>
                <span class="nav-default">Using Oauth2</span>
                <span class="nav-mobile">Prev</span>
            </a>
        
        
            <a class="next" href="/2016/08/02/20160809-guide-to-FP-part1/">
                <span class="nav-default">Frisby&#39;s Mostly Adequate Guide to Functional Programming - Part 1</span>
                <span class="nav-mobile">Next</span>
                <i class="iconfont icon-next"></i>
            </a>
        
    
</div>
<div id="comment-container"></div>
    </div>
</div>
<footer class="footer-social">
    
    <a class="social-link" target="_blank" href="https://github.com/dearfrankg">
        <i class="iconfont icon-github"></i>
    </a>
    

    

    

    <div class="footer-copyright">
        <p class="time-line">
            &copy;
            
            
            2018
            &nbsp;<i class="iconfont icon-heart"></i>&nbsp;
            <a target="_blank" href="https://github.com/dearfrankg">Frank Gutierrez</a>
        </p>
    </div>
</footer>
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="/js/index.js"></script>
<!-- <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script> -->
<script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
<script>
    
    var gitment = new Gitment({
        id: 'Frisby's Mostly Adequate Guide to Functional Programming - Part 2',
        owner: 'dearfrankg',
        repo: 'blog-comments',
        oauth: {
            client_id: '1e06b3865efbfdedf5d0',
            client_secret: 'cd2f93735df5d8dfa8acda7897bcf8bae1559f9b'
        }
    });
    gitment.render('comment-container');
    

</script>
</html>
