<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
    <title>dev notes</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/gitment.css">
    <link rel="stylesheet" href="/css/font_859455_eaq7v6w8ktj.css">
</head>

<body>
<header class="header">
    <div class="header-inner">
        <div class="header-title">

        </div>
        <nav class="header-nav">
            
            <a href="/" class="header-nav-link">
                Home
            </a>
            

            
            <a href="/archives" class="header-nav-link">
                Archives
            </a>
            

            
            <a href="/tags" class="header-nav-link">
                Tags
            </a>
            

            
        </nav>
    </div>
</header>
<header class="mobile-header">
    <div class="mobile-nav">
        <div class="mobile-nav-icon">
            <span></span>
            <span></span>
            <span></span>
        </div>
        <div class="mobile-nav-title">
            <a href="/" class="mobile-nav-title-link">Frank Gutierrez's Blog</a>
        </div>

    </div>
    <nav class="mobile-menu">
        <ul class="mobile-menu-list">
            <li class="mobile-menu-item">
                <i class="iconfont icon-home"></i>
                <a href="/" class="mobile-nav-link">Home</a>
            </li>
            <li class="mobile-menu-item">
                <i class="iconfont icon-archive"></i>
                <a href="/archives" class="mobile-nav-link">Archives</a>
            </li>
            <li class="mobile-menu-item">
                <i class="iconfont icon-tag"></i>
                <a href="/tags" class="mobile-nav-link">Tags</a>
            </li>
            <li class="mobile-menu-item">
                <i class="iconfont icon-about"></i>
                <a href="/about/" class="mobile-nav-link">About</a>
            </li>
        </ul>
    </nav>
</header>
<div class="main">
    <div class="content-inner">
        <div class="posts">
    
        <article class="post-abstract">
            <div class="post-title">
                <h2><a class="post-title-link" href="/2016/11/19/20161119-gitlab-setup/">Gitlab Setup</a></h2>
            </div>
            <div class="post-meta">
                <span class="post-time">2016-11-19</span>
                
            </div>
            <div class="post-content">
                
                    <h2 id="Getting-Started"><a href="#Getting-Started" class="headerlink" title="Getting Started"></a>Getting Started</h2><p>There are 2 flavors</p>
<ul>
<li>Community Edition</li>
<li>Enterprise Edition</li>
</ul>
<p>Omnibus is a way to package different services and tools required to run GitLab, so that most of developers can install it without laborious configuration</p>
<h2 id="Resources"><a href="#Resources" class="headerlink" title="Resources:"></a>Resources:</h2><ul>
<li><a href="https://goo.gl/8KCB00" target="_blank" rel="noopener">Omnibus GitLab documentation</a></li>
<li><a href="https://goo.gl/tuOdyy" target="_blank" rel="noopener">Community Edition Repo</a></li>
<li><a href="https://goo.gl/siAOxa" target="_blank" rel="noopener">Getting help with Gitlab</a></li>
<li><a href="https://docs.gitlab.com/ce/api/README.html" target="_blank" rel="noopener">Gitlab API docs</a></li>
</ul>
<h2 id="Install-and-Configure-Gitlab"><a href="#Install-and-Configure-Gitlab" class="headerlink" title="Install and Configure Gitlab"></a>Install and Configure Gitlab</h2><ul>
<li><a href="https://goo.gl/QcA8iM" target="_blank" rel="noopener">Set up the GitLab in Docker container</a></li>
</ul>
<ol>
<li>create docker host (gitlab)</li>
<li>switch control to docker host</li>
<li>run gitlab image (downloads and configures in one step)</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">docker run --detach \</span><br><span class="line">  --name gitlab \</span><br><span class="line">  --hostname gitlab.debugtime.com \</span><br><span class="line">  --restart always \</span><br><span class="line">  --publish 80:80 --publish 2289:22 \</span><br><span class="line">  --volume /opt/docker/gitlab/config:/etc/gitlab \</span><br><span class="line">  --volume /opt/docker/gitlab/logs:/var/log/gitlab \</span><br><span class="line">  --volume /opt/docker/gitlab/data:/var/opt/gitlab \</span><br><span class="line">  --env GITLAB_OMNIBUS_CONFIG=&quot;external_url &apos;http://gitlab.debugtime.com/&apos;; gitlab_rails[&apos;gitlab_shell_ssh_port&apos;] = 2289&quot; \</span><br><span class="line">  gitlab/gitlab-ce:latest</span><br></pre></td></tr></table></figure>
<h4 id="Setup-web-access"><a href="#Setup-web-access" class="headerlink" title="Setup web access"></a>Setup web access</h4><ol>
<li>get the gitlab docker host IP</li>
<li>configure an nginx reverse proxy: <code>gitlab.debugtime.com</code> –&gt; <code>&lt;gitlab_docker_host_ip&gt;:80</code></li>
</ol>
<h4 id="Setup-ssh-access"><a href="#Setup-ssh-access" class="headerlink" title="Setup ssh access"></a>Setup ssh access</h4><p>1) configure gitlab to route ssh traffic from <code>gitlab:2289</code> to <code>container:22</code></p>
<p>We can map web traffic like so <code>-p 80:80</code> which routes <code>container:80</code> to <code>gitlab:80</code>.  Since <code>gitlab:22</code> is already being used to allow login into the gitlab host, we cannot use that port.  So instead we will map <code>container:22</code> to <code>gitlab:2289</code> with the docker run option <code>--publish 2289:22</code></p>
<p>2) set Omnibus configuration so gitlab provides commands that account for port 2289.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--env GITLAB_OMNIBUS_CONFIG=&quot;external_url &apos;http://gitlab.debugtime.com/&apos;; gitlab_rails[&apos;gitlab_shell_ssh_port&apos;] = 2289&quot; \</span><br></pre></td></tr></table></figure>
<p>3) setup ssh tunnel between <code>gitlab.debugtime.com:2289</code> and <code>gitlab:2289</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-machine ssh gitlab -fN -L 0.0.0.0:2289:localhost:2289</span><br></pre></td></tr></table></figure>
<h2 id="Test-Gitlab"><a href="#Test-Gitlab" class="headerlink" title="Test Gitlab"></a>Test Gitlab</h2><h4 id="Verify-Gitlab’s-web-app-functionality"><a href="#Verify-Gitlab’s-web-app-functionality" class="headerlink" title="Verify Gitlab’s web app functionality"></a>Verify Gitlab’s web app functionality</h4><ul>
<li><code>open http://gitlab.debugtime.com</code></li>
</ul>
<h4 id="Verify-Gitlab’s-push-pull-functionality"><a href="#Verify-Gitlab’s-push-pull-functionality" class="headerlink" title="Verify Gitlab’s push/pull functionality"></a>Verify Gitlab’s push/pull functionality</h4><ol>
<li><p>test pull functionality:<br><code>git clone ssh://git@gitlab.debugtime.com:2289/dearfrankg/myproject.git</code></p>
</li>
<li><p>commit change to master branch</p>
</li>
<li><p>test push functionality:<br><code>git push -u origin master</code></p>
</li>
</ol>

                
            </div>
        </article>
    
        <article class="post-abstract">
            <div class="post-title">
                <h2><a class="post-title-link" href="/2016/11/18/20161118-nginx-proxy/">Docker – nginx-proxy</a></h2>
            </div>
            <div class="post-meta">
                <span class="post-time">2016-11-18</span>
                
            </div>
            <div class="post-content">
                
                    <h2 id="Automatic-nginx-config-for-containers-using-an-env-var"><a href="#Automatic-nginx-config-for-containers-using-an-env-var" class="headerlink" title="Automatic nginx config for containers using an env var"></a>Automatic nginx config for containers using an env var</h2><ul>
<li><a href="https://hub.docker.com/r/jwilder/nginx-proxy/" target="_blank" rel="noopener">nginx-proxy</a></li>
</ul>
<h3 id="Configure-Domain-and-Subdomains"><a href="#Configure-Domain-and-Subdomains" class="headerlink" title="Configure Domain and Subdomains"></a>Configure Domain and Subdomains</h3><blockquote>
<p>You will require a registered domain name to do this</p>
</blockquote>
<ul>
<li>Configure DNS to point domain and subdomains to home router</li>
<li>Configure router to setup virtual server pointing to my laptop</li>
</ul>
<h3 id="Enable-docker-through-the-firewall"><a href="#Enable-docker-through-the-firewall" class="headerlink" title="Enable docker through the firewall"></a>Enable docker through the firewall</h3><blockquote>
<p>NOTE<br>I cannot get docker to popup <code>allow incoming connections</code></p>
</blockquote>
<p>Because of the firewall problem we have to use nginx to proxy to nginx-proxy</p>
<h4 id="usr-local-etc-nginx-servers-nginx-proxy-conf"><a href="#usr-local-etc-nginx-servers-nginx-proxy-conf" class="headerlink" title="/usr/local/etc/nginx/servers/nginx-proxy.conf"></a>/usr/local/etc/nginx/servers/nginx-proxy.conf</h4><pre><code>server {

  # server_name localhost *.debugtime.com debugtime.com;
  listen 80;
  listen [::]:80;

  set $upstream 127.0.0.1:8080;

  location / {
    proxy_pass_header Authorization;
    proxy_pass http://$upstream;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_http_version 1.1;
    proxy_set_header Connection &quot;&quot;;
    proxy_buffering off;
    client_max_body_size 0;
    proxy_read_timeout 36000s;
    proxy_redirect off;
  }

}
</code></pre><h4 id="Start-nginx"><a href="#Start-nginx" class="headerlink" title="Start nginx"></a>Start nginx</h4><pre><code>sudo brew services start nginx
</code></pre><h3 id="Start-nginx-proxy"><a href="#Start-nginx-proxy" class="headerlink" title="Start nginx-proxy"></a>Start nginx-proxy</h3><pre><code>docker run -d -p 8080:80 --name nginx-proxy \
  -v /var/run/docker.sock:/tmp/docker.sock:ro jwilder/nginx-proxy
</code></pre><h3 id="Test-your-domain-when-the-service-is-down"><a href="#Test-your-domain-when-the-service-is-down" class="headerlink" title="Test your domain when the service is down"></a>Test your domain when the service is down</h3><pre><code>curl -I debugtime.com

    HTTP/1.1 503 Service Temporarily Unavailable
    [...]
</code></pre><h3 id="Start-your-services"><a href="#Start-your-services" class="headerlink" title="Start your services"></a>Start your services</h3><p>The containers being proxied must expose the port to be proxied, either by using the EXPOSE directive in their Dockerfile or by using the –expose flag to docker run or docker create.</p>
<p>You will need:</p>
<ul>
<li>set the env var: <code>-e VIRTUAL_HOST=www.mydomain.com,mydomain.com</code></li>
<li>expose the port: <code>--expose &lt;service port&gt;</code></li>
</ul>
<blockquote>
<p>NOTE<br>You might be wondering what’s the difference between using <code>-p</code> and <code>--expose</code><br><code>--expose &lt;service_port&gt;</code> is for inter-container communications<br><code>-p &lt;host_port&gt;:&lt;container_port&gt;</code> is for opening access to the world</p>
</blockquote>
<h4 id="start-service-and-assign-to-www-debugtime-com-and-debugtime-com"><a href="#start-service-and-assign-to-www-debugtime-com-and-debugtime-com" class="headerlink" title="start service and assign to www.debugtime.com and debugtime.com"></a>start service and assign to <a href="http://www.debugtime.com" target="_blank" rel="noopener">www.debugtime.com</a> and debugtime.com</h4><pre><code>docker run -d \
  -e VIRTUAL_HOST=www.debugtime.com,debugtime.com \
  --name debugtime.com \
  nginx
</code></pre><blockquote>
<p>nginx exposes port 80 and 443<br>you can see that with <code>docker inspect nginx</code></p>
</blockquote>
<h4 id="start-service-and-assign-to-foo-debugtime-com"><a href="#start-service-and-assign-to-foo-debugtime-com" class="headerlink" title="start service and assign to foo.debugtime.com"></a>start service and assign to foo.debugtime.com</h4><pre><code>docker run -d \
  -e VIRTUAL_HOST=foo.debugtime.com \
  --name foo.debugtime.com \
  nginx
</code></pre><h3 id="Test-nginx-proxy-with-services-to-proxy-to"><a href="#Test-nginx-proxy-with-services-to-proxy-to" class="headerlink" title="Test nginx-proxy with services to proxy to"></a>Test nginx-proxy with services to proxy to</h3><pre><code>curl -I debugtime.com

    HTTP/1.1 200 OK
    [...]

curl -I www.debugtime.com

    HTTP/1.1 200 OK
    [...]

curl -I foo.debugtime.com

    HTTP/1.1 200 OK
    [...]
</code></pre>
                
            </div>
        </article>
    
        <article class="post-abstract">
            <div class="post-title">
                <h2><a class="post-title-link" href="/2016/11/18/20161118-my-docker-farm/">Docker – My Docker Infrastructure</a></h2>
            </div>
            <div class="post-meta">
                <span class="post-time">2016-11-18</span>
                
            </div>
            <div class="post-content">
                
                    <p>I’m going to tell you how I get my Docker Infrastructure up and running.</p>
<h2 id="Firing-up-the-monster"><a href="#Firing-up-the-monster" class="headerlink" title="Firing up the monster"></a>Firing up the monster</h2><h4 id="Tools"><a href="#Tools" class="headerlink" title="Tools"></a>Tools</h4><ul>
<li>docker tools (docker, docker-machine, docker-machine-driver-xhyve)</li>
<li>bash scripts</li>
<li>rancher</li>
<li>nginx</li>
<li>nginx-proxy</li>
</ul>
<h4 id="The-firewall"><a href="#The-firewall" class="headerlink" title="The firewall"></a>The firewall</h4><p>Docker does not configure the firewall to accept incoming conections.  As a result we have to use nginx as a reverse-proxy to get past the firewall.</p>
<p>That means when we call <code>mydomain.com</code> my DNS server and router are configured to go to my laptop.  When they reach my laptop on port 80</p>
<p>This is the route that you will take to get to my services.</p>
<ol>
<li>DNS and router -&gt; laptop</li>
<li>laptop firewall -&gt; port 80 to nginx</li>
<li>nginx -&gt; nginx-proxy</li>
<li>nginx-proxy auto-configures itself by scanning containers to see which domain they are configured for.</li>
<li>service containers set an env var to identify the domain they handle</li>
</ol>
<p>My services are mapped to the following domains:</p>
<pre><code>debugtime.com         -&gt; nginx -&gt; nginx-proxy -&gt; reactioncommerce
rancher.debugtime.com -&gt; nginx -&gt; nginx-proxy -&gt; rancher
blog.debugtime.com    -&gt; nginx -&gt; nginx-proxy -&gt; hexo
</code></pre>
                
            </div>
        </article>
    
</div>
<div class="paginator">
    
        
        <a class="prev" href="/page/14/">
            <i class="iconfont icon-prev"></i>
            Prev
        </a>
        
        
        <a class="next" href="/page/16/">
            Next
            <i class="iconfont icon-next"></i>
        </a>
        
    
</div>

    </div>
</div>
<footer class="footer-social">
    
    <a class="social-link" target="_blank" href="https://github.com/dearfrankg">
        <i class="iconfont icon-github"></i>
    </a>
    

    

    

    <div class="footer-copyright">
        <p class="time-line">
            &copy;
            
            
            2018
            &nbsp;<i class="iconfont icon-heart"></i>&nbsp;
            <a target="_blank" href="https://github.com/iJinxin">Frank Gutierrez</a>
        </p>
        <p class="theme-info">
            Powered by <a target="_blank" href="https://hexo.io">Hexo</a>  |  Theme -
            <a target="_blank" href="https://github.com/iJinxin/hexo-theme-sky">Sky</a>
        </p>
    </div>
</footer>
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="/js/index.js"></script>
<!-- <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script> -->
<script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
<script>
    

</script>
</html>
