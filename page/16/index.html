<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
    <title>dev notes</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/gitment.css">
    <link rel="stylesheet" href="/css/font_859455_eaq7v6w8ktj.css">
</head>

<body>
<header class="header">
    <div class="header-inner">
        <div class="header-title">

        </div>
        <nav class="header-nav">
            
            <a href="/" class="header-nav-link">
                Home
            </a>
            

            
            <a href="/archives" class="header-nav-link">
                Archives
            </a>
            

            
            <a href="/tags" class="header-nav-link">
                Tags
            </a>
            

            
        </nav>
    </div>
</header>
<header class="mobile-header">
    <div class="mobile-nav">
        <div class="mobile-nav-icon">
            <span></span>
            <span></span>
            <span></span>
        </div>
        <div class="mobile-nav-title">
            <a href="/" class="mobile-nav-title-link">Frank Gutierrez's Blog</a>
        </div>

    </div>
    <nav class="mobile-menu">
        <ul class="mobile-menu-list">
            <li class="mobile-menu-item">
                <i class="iconfont icon-home"></i>
                <a href="/" class="mobile-nav-link">Home</a>
            </li>
            <li class="mobile-menu-item">
                <i class="iconfont icon-archive"></i>
                <a href="/archives" class="mobile-nav-link">Archives</a>
            </li>
            <li class="mobile-menu-item">
                <i class="iconfont icon-tag"></i>
                <a href="/tags" class="mobile-nav-link">Tags</a>
            </li>
            <li class="mobile-menu-item">
                <i class="iconfont icon-about"></i>
                <a href="/about/" class="mobile-nav-link">About</a>
            </li>
        </ul>
    </nav>
</header>
<div class="main">
    <div class="content-inner">
        <div class="posts">
    
        <article class="post-abstract">
            <div class="post-title">
                <h2><a class="post-title-link" href="/2016/11/18/2016/20161118-nginx-proxy/">Docker – nginx-proxy</a></h2>
            </div>
            <div class="post-meta">
                <span class="post-time">2016-11-18</span>
                
            </div>
            <div class="post-content">
                
                    <h2 id="Automatic-nginx-config-for-containers-using-an-env-var"><a href="#Automatic-nginx-config-for-containers-using-an-env-var" class="headerlink" title="Automatic nginx config for containers using an env var"></a>Automatic nginx config for containers using an env var</h2><ul>
<li><a href="https://hub.docker.com/r/jwilder/nginx-proxy/" target="_blank" rel="noopener">nginx-proxy</a></li>
</ul>
<h3 id="Configure-Domain-and-Subdomains"><a href="#Configure-Domain-and-Subdomains" class="headerlink" title="Configure Domain and Subdomains"></a>Configure Domain and Subdomains</h3><blockquote>
<p>You will require a registered domain name to do this</p>
</blockquote>
<ul>
<li>Configure DNS to point domain and subdomains to home router</li>
<li>Configure router to setup virtual server pointing to my laptop</li>
</ul>
<h3 id="Enable-docker-through-the-firewall"><a href="#Enable-docker-through-the-firewall" class="headerlink" title="Enable docker through the firewall"></a>Enable docker through the firewall</h3><blockquote>
<p>NOTE<br>I cannot get docker to popup <code>allow incoming connections</code></p>
</blockquote>
<p>Because of the firewall problem we have to use nginx to proxy to nginx-proxy</p>
<h4 id="usr-local-etc-nginx-servers-nginx-proxy-conf"><a href="#usr-local-etc-nginx-servers-nginx-proxy-conf" class="headerlink" title="/usr/local/etc/nginx/servers/nginx-proxy.conf"></a>/usr/local/etc/nginx/servers/nginx-proxy.conf</h4><pre><code>server {

  # server_name localhost *.debugtime.com debugtime.com;
  listen 80;
  listen [::]:80;

  set $upstream 127.0.0.1:8080;

  location / {
    proxy_pass_header Authorization;
    proxy_pass http://$upstream;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_http_version 1.1;
    proxy_set_header Connection &quot;&quot;;
    proxy_buffering off;
    client_max_body_size 0;
    proxy_read_timeout 36000s;
    proxy_redirect off;
  }

}
</code></pre><h4 id="Start-nginx"><a href="#Start-nginx" class="headerlink" title="Start nginx"></a>Start nginx</h4><pre><code>sudo brew services start nginx
</code></pre><h3 id="Start-nginx-proxy"><a href="#Start-nginx-proxy" class="headerlink" title="Start nginx-proxy"></a>Start nginx-proxy</h3><pre><code>docker run -d -p 8080:80 --name nginx-proxy \
  -v /var/run/docker.sock:/tmp/docker.sock:ro jwilder/nginx-proxy
</code></pre><h3 id="Test-your-domain-when-the-service-is-down"><a href="#Test-your-domain-when-the-service-is-down" class="headerlink" title="Test your domain when the service is down"></a>Test your domain when the service is down</h3><pre><code>curl -I debugtime.com

    HTTP/1.1 503 Service Temporarily Unavailable
    [...]
</code></pre><h3 id="Start-your-services"><a href="#Start-your-services" class="headerlink" title="Start your services"></a>Start your services</h3><p>The containers being proxied must expose the port to be proxied, either by using the EXPOSE directive in their Dockerfile or by using the –expose flag to docker run or docker create.</p>
<p>You will need:</p>
<ul>
<li>set the env var: <code>-e VIRTUAL_HOST=www.mydomain.com,mydomain.com</code></li>
<li>expose the port: <code>--expose &lt;service port&gt;</code></li>
</ul>
<blockquote>
<p>NOTE<br>You might be wondering what’s the difference between using <code>-p</code> and <code>--expose</code><br><code>--expose &lt;service_port&gt;</code> is for inter-container communications<br><code>-p &lt;host_port&gt;:&lt;container_port&gt;</code> is for opening access to the world</p>
</blockquote>
<h4 id="start-service-and-assign-to-www-debugtime-com-and-debugtime-com"><a href="#start-service-and-assign-to-www-debugtime-com-and-debugtime-com" class="headerlink" title="start service and assign to www.debugtime.com and debugtime.com"></a>start service and assign to <a href="http://www.debugtime.com" target="_blank" rel="noopener">www.debugtime.com</a> and debugtime.com</h4><pre><code>docker run -d \
  -e VIRTUAL_HOST=www.debugtime.com,debugtime.com \
  --name debugtime.com \
  nginx
</code></pre><blockquote>
<p>nginx exposes port 80 and 443<br>you can see that with <code>docker inspect nginx</code></p>
</blockquote>
<h4 id="start-service-and-assign-to-foo-debugtime-com"><a href="#start-service-and-assign-to-foo-debugtime-com" class="headerlink" title="start service and assign to foo.debugtime.com"></a>start service and assign to foo.debugtime.com</h4><pre><code>docker run -d \
  -e VIRTUAL_HOST=foo.debugtime.com \
  --name foo.debugtime.com \
  nginx
</code></pre><h3 id="Test-nginx-proxy-with-services-to-proxy-to"><a href="#Test-nginx-proxy-with-services-to-proxy-to" class="headerlink" title="Test nginx-proxy with services to proxy to"></a>Test nginx-proxy with services to proxy to</h3><pre><code>curl -I debugtime.com

    HTTP/1.1 200 OK
    [...]

curl -I www.debugtime.com

    HTTP/1.1 200 OK
    [...]

curl -I foo.debugtime.com

    HTTP/1.1 200 OK
    [...]
</code></pre>
                
            </div>
        </article>
    
        <article class="post-abstract">
            <div class="post-title">
                <h2><a class="post-title-link" href="/2016/11/18/2016/20161118-my-docker-farm/">Docker – My Docker Infrastructure</a></h2>
            </div>
            <div class="post-meta">
                <span class="post-time">2016-11-18</span>
                
            </div>
            <div class="post-content">
                
                    <p>I’m going to tell you how I get my Docker Infrastructure up and running.</p>
<h2 id="Firing-up-the-monster"><a href="#Firing-up-the-monster" class="headerlink" title="Firing up the monster"></a>Firing up the monster</h2><h4 id="Tools"><a href="#Tools" class="headerlink" title="Tools"></a>Tools</h4><ul>
<li>docker tools (docker, docker-machine, docker-machine-driver-xhyve)</li>
<li>bash scripts</li>
<li>rancher</li>
<li>nginx</li>
<li>nginx-proxy</li>
</ul>
<h4 id="The-firewall"><a href="#The-firewall" class="headerlink" title="The firewall"></a>The firewall</h4><p>Docker does not configure the firewall to accept incoming conections.  As a result we have to use nginx as a reverse-proxy to get past the firewall.</p>
<p>That means when we call <code>mydomain.com</code> my DNS server and router are configured to go to my laptop.  When they reach my laptop on port 80</p>
<p>This is the route that you will take to get to my services.</p>
<ol>
<li>DNS and router -&gt; laptop</li>
<li>laptop firewall -&gt; port 80 to nginx</li>
<li>nginx -&gt; nginx-proxy</li>
<li>nginx-proxy auto-configures itself by scanning containers to see which domain they are configured for.</li>
<li>service containers set an env var to identify the domain they handle</li>
</ol>
<p>My services are mapped to the following domains:</p>
<pre><code>debugtime.com         -&gt; nginx -&gt; nginx-proxy -&gt; reactioncommerce
rancher.debugtime.com -&gt; nginx -&gt; nginx-proxy -&gt; rancher
blog.debugtime.com    -&gt; nginx -&gt; nginx-proxy -&gt; hexo
</code></pre>
                
            </div>
        </article>
    
        <article class="post-abstract">
            <div class="post-title">
                <h2><a class="post-title-link" href="/2016/11/18/2016/20161118-docker-manage-a-swarm-part2/">Docker – Manage a Swarm Part 2</a></h2>
            </div>
            <div class="post-meta">
                <span class="post-time">2016-11-18</span>
                
            </div>
            <div class="post-content">
                
                    <!-- TOC depthFrom:1 depthTo:2 withLinks:0 updateOnSave:1 orderedList:0 -->
<ul>
<li>Get started with swarm mode<ul>
<li>Setup for the tutorial</li>
<li>Create a swarm</li>
<li>Add nodes to the swarm</li>
<li>Deploy a service</li>
<li>Inspect a service</li>
<li>Scale a service</li>
<li>Delete the service</li>
<li>Apply rolling updates</li>
<li>Drain the node</li>
</ul>
</li>
</ul>
<!-- /TOC -->
<h1 id="Get-started-with-swarm-mode"><a href="#Get-started-with-swarm-mode" class="headerlink" title="Get started with swarm mode"></a>Get started with swarm mode</h1><p>The tutorial guides you through the following activities:</p>
<ul>
<li>initializing a cluster of Docker Engines in swarm mode</li>
<li>adding nodes to the swarm</li>
<li>deploying application services to the swarm</li>
<li>managing the swarm once you have everything running</li>
</ul>
<h2 id="Setup-for-the-tutorial"><a href="#Setup-for-the-tutorial" class="headerlink" title="Setup for the tutorial"></a>Setup for the tutorial</h2><p>To run this tutorial, you need the following:</p>
<ul>
<li>three networked host machines</li>
<li>Docker Engine 1.12 or later installed</li>
<li>the IP address of the manager machine</li>
<li>open ports between the hosts</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">// setup 3 networked host machines (dkCreateHost is my bash function)</span><br><span class="line"></span><br><span class="line">  dkCreateHost manager1 ; dkCreateHost worker1 ; dkCreateHost worker2</span><br><span class="line"></span><br><span class="line">    [...]</span><br><span class="line"></span><br><span class="line">// see new machines</span><br><span class="line"></span><br><span class="line">  docker-machine ls</span><br><span class="line"></span><br><span class="line">// get the IP address of the manager machine</span><br><span class="line"></span><br><span class="line">  docker-machine ip manager1</span><br><span class="line"></span><br><span class="line">    192.168.64.24</span><br><span class="line"></span><br><span class="line">// Open ports between the hosts</span><br><span class="line"></span><br><span class="line">  TCP port 2377 for cluster management communications</span><br><span class="line">  TCP and UDP port 7946 for communication among nodes</span><br><span class="line">  TCP and UDP port 4789 for overlay network traffic</span><br><span class="line"></span><br><span class="line">    ASSUMING THEY ARE OPEN BY DEFAULT</span><br></pre></td></tr></table></figure>
<h2 id="Create-a-swarm"><a href="#Create-a-swarm" class="headerlink" title="Create a swarm"></a>Create a swarm</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">// ssh into manager node</span><br><span class="line"></span><br><span class="line">  bash docker-machine ssh manager1</span><br><span class="line"></span><br><span class="line">// create new swarm</span><br><span class="line"></span><br><span class="line">  docker swarm init                                   // IF DOCKER_FOR_MAC</span><br><span class="line">  docker swarm init --advertise-addr &lt;MANAGER-IP&gt;     // IF NOT DOCKER_FOR_MAC</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      Swarm initialized: current node (b6o6chvidibsnbbqp1ximau36) is now a manager.</span><br><span class="line"></span><br><span class="line">      To add a worker to this swarm, run the following command:</span><br><span class="line"></span><br><span class="line">          docker swarm join \</span><br><span class="line">          --token SWMTKN-1-32428f9y2gf98blwa7ko930v3w484ffkbuzwr0rebrrfelwl75-832m3a1hd1pq54kocro2p87xj \</span><br><span class="line">          192.168.64.24:2377</span><br><span class="line"></span><br><span class="line">      To add a manager to this swarm, run &apos;docker swarm join-token manager&apos; and follow the instructions.</span><br><span class="line"></span><br><span class="line">// view swarm state</span><br><span class="line"></span><br><span class="line">  docker info</span><br><span class="line"></span><br><span class="line">      Containers: 0</span><br><span class="line">      Running: 0</span><br><span class="line">      Paused: 0</span><br><span class="line">      Stopped: 0</span><br><span class="line">      [...]</span><br><span class="line"></span><br><span class="line">// view node info</span><br><span class="line"></span><br><span class="line">  docker node ls</span><br><span class="line"></span><br><span class="line">      ID                           HOSTNAME  STATUS  AVAILABILITY  MANAGER STATUS</span><br><span class="line">      b6o6chvidibsnbbqp1ximau36 *  manager1  Ready   Active        Leader</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      - The * next to the node id indicates that you’re currently connected on this node.</span><br><span class="line">      - Docker Engine swarm mode automatically names the node for the machine host name.</span><br><span class="line">      The tutorial covers other columns in later steps.</span><br></pre></td></tr></table></figure>
<h2 id="Add-nodes-to-the-swarm"><a href="#Add-nodes-to-the-swarm" class="headerlink" title="Add nodes to the swarm"></a>Add nodes to the swarm</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">// add worker1 and worker2 to the swarm</span><br><span class="line"></span><br><span class="line">  # ssh into worker1</span><br><span class="line">  docker-machine ssh worker1</span><br><span class="line"></span><br><span class="line">  # add node to swarm</span><br><span class="line"></span><br><span class="line">      docker swarm join \</span><br><span class="line">      --token SWMTKN-1-32428f9y2gf98blwa7ko930v3w484ffkbuzwr0rebrrfelwl75-832m3a1hd1pq54kocro2p87xj \</span><br><span class="line">      192.168.64.24:2377</span><br><span class="line"></span><br><span class="line">  # repeat steps for worker2</span><br><span class="line"></span><br><span class="line">// see swarm nodes</span><br><span class="line"></span><br><span class="line">  # ssh into manager1</span><br><span class="line">  docker-machine ssh manager1</span><br><span class="line"></span><br><span class="line">  # list nodes</span><br><span class="line">  docker node ls</span><br><span class="line"></span><br><span class="line">      ID                           HOSTNAME  STATUS  AVAILABILITY  MANAGER STATUS</span><br><span class="line">      5hfb7vaclplat92apq1ugc40v    worker1   Ready   Active</span><br><span class="line">      b6o6chvidibsnbbqp1ximau36 *  manager1  Ready   Active        Leader</span><br><span class="line">      bx5oreu7adss9zt14it1cv30p    worker2   Ready   Active</span><br></pre></td></tr></table></figure>
<h2 id="Deploy-a-service"><a href="#Deploy-a-service" class="headerlink" title="Deploy a service"></a>Deploy a service</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">// ssh into manager1</span><br><span class="line"></span><br><span class="line">  docker-machine ssh manager1</span><br><span class="line"></span><br><span class="line">// create a service</span><br><span class="line"></span><br><span class="line">  docker service create --replicas 1 --name hello alpine ping docker.com</span><br><span class="line"></span><br><span class="line">// list services</span><br><span class="line"></span><br><span class="line">  docker service ls</span><br><span class="line"></span><br><span class="line">      ID            NAME   REPLICAS  IMAGE   COMMAND</span><br><span class="line">      0cd3kt96c1ta  hello  1/1       alpine  ping docker.com</span><br></pre></td></tr></table></figure>
<h2 id="Inspect-a-service"><a href="#Inspect-a-service" class="headerlink" title="Inspect a service"></a>Inspect a service</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">// ssh into manager1</span><br><span class="line"></span><br><span class="line">  docker-machine ssh manager1</span><br><span class="line"></span><br><span class="line">// inspect service</span><br><span class="line"></span><br><span class="line">  docker service inspect --pretty hello</span><br><span class="line"></span><br><span class="line">      ID:		0cd3kt96c1takhb4kzzu3hfds</span><br><span class="line">      Name:		hello</span><br><span class="line">      Mode:		Replicated</span><br><span class="line">       Replicas:	1</span><br><span class="line">      Placement:</span><br><span class="line">      UpdateConfig:</span><br><span class="line">       Parallelism:	1</span><br><span class="line">       On failure:	pause</span><br><span class="line">      ContainerSpec:</span><br><span class="line">       Image:		alpine</span><br><span class="line">       Args:		ping docker.com</span><br><span class="line">      Resources:</span><br><span class="line"></span><br><span class="line">// inspect service in json format</span><br><span class="line"></span><br><span class="line">  docker service inspect hello</span><br><span class="line"></span><br><span class="line">      [</span><br><span class="line">          &#123;</span><br><span class="line">              &quot;ID&quot;: &quot;0cd3kt96c1takhb4kzzu3hfds&quot;,</span><br><span class="line">              &quot;Version&quot;: &#123;</span><br><span class="line">                  &quot;Index&quot;: 22</span><br><span class="line">              &#125;,</span><br><span class="line">              &quot;CreatedAt&quot;: &quot;2016-11-18T01:13:24.443476961Z&quot;,</span><br><span class="line">              &quot;UpdatedAt&quot;: &quot;2016-11-18T01:13:24.443476961Z&quot;,</span><br><span class="line">              &quot;Spec&quot;: &#123;</span><br><span class="line">      [...]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// see service nodes</span><br><span class="line"></span><br><span class="line">  docker service ps hello</span><br><span class="line"></span><br><span class="line">      ID                         NAME     IMAGE   NODE      DESIRED STATE  CURRENT STATE          ERROR</span><br><span class="line">      deo5pa5lstobae1dgilpqrqnz  hello.1  alpine  manager1  Running        Running 6 minutes ago</span><br><span class="line"></span><br><span class="line">// check the node for container details</span><br><span class="line"></span><br><span class="line">  docker ps</span><br><span class="line"></span><br><span class="line">      CONTAINER ID  ... STATUS              PORTS               NAMES</span><br><span class="line">      2d4ee26d618b  ... 18 minutes ago      Up 18 minutes       hello.1.deo5pa5lstobae1dgilpqrqnz</span><br></pre></td></tr></table></figure>
<h2 id="Scale-a-service"><a href="#Scale-a-service" class="headerlink" title="Scale a service"></a>Scale a service</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">// ssh into manager1</span><br><span class="line"></span><br><span class="line">  docker-machine ssh manager1</span><br><span class="line"></span><br><span class="line">// scale the service</span><br><span class="line"></span><br><span class="line">  docker service scale hello=5</span><br><span class="line"></span><br><span class="line">      hello scaled to 5</span><br><span class="line"></span><br><span class="line">// see task list</span><br><span class="line"></span><br><span class="line">  docker service ps hello</span><br><span class="line"></span><br><span class="line">      ID                         NAME     IMAGE   NODE      DESIRED STATE  CURRENT STATE           ERROR</span><br><span class="line">      deo5pa5lstobae1dgilpqrqnz  hello.1  alpine  manager1  Running        Running 25 minutes ago</span><br><span class="line">      6nieysy0h1go6v5yrtbyrt53k  hello.2  alpine  worker2   Running        Running 29 seconds ago</span><br><span class="line">      bvl03me8ru6d3zm8j32iluyw9  hello.3  alpine  worker1   Running        Running 29 seconds ago</span><br><span class="line">      cpjon94jxxthliuomhuiei8e7  hello.4  alpine  worker1   Running        Running 29 seconds ago</span><br><span class="line">      3ybrznl0v1vst19wtau3fq25x  hello.5  alpine  manager1  Running        Running 32 seconds ago</span><br><span class="line"></span><br><span class="line">// see node container info</span><br><span class="line"></span><br><span class="line">  docker ps</span><br><span class="line"></span><br><span class="line">      CONTAINER ID   ... STATUS              PORTS               NAMES</span><br><span class="line">      724323616e6c   ... Up 4 minutes                            hello.5.3ybrznl0v1vst19wtau3fq25x</span><br><span class="line">      2d4ee26d618b   ... Up 29 minutes                           hello.1.deo5pa5lstobae1dgilpqrqnz</span><br></pre></td></tr></table></figure>
<h2 id="Delete-the-service"><a href="#Delete-the-service" class="headerlink" title="Delete the service"></a>Delete the service</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">// ssh into manager1</span><br><span class="line"></span><br><span class="line">  docker-machine ssh manager1</span><br><span class="line"></span><br><span class="line">// remove service</span><br><span class="line"></span><br><span class="line">  docker service rm hello</span><br><span class="line"></span><br><span class="line">      hello</span><br><span class="line"></span><br><span class="line">// verify service removal</span><br><span class="line"></span><br><span class="line">  docker inspect hello</span><br><span class="line"></span><br><span class="line">      []</span><br><span class="line">      Error: no such service: hello</span><br></pre></td></tr></table></figure>
<h2 id="Apply-rolling-updates"><a href="#Apply-rolling-updates" class="headerlink" title="Apply rolling updates"></a>Apply rolling updates</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">// ssh into manager1</span><br><span class="line"></span><br><span class="line">  docker-machine ssh manager1</span><br><span class="line"></span><br><span class="line">// deploy Redis 3.0.6 to the swarm with a 10 second update delay</span><br><span class="line"></span><br><span class="line">  docker service create \</span><br><span class="line">    --replicas 3 \</span><br><span class="line">    --name redis \</span><br><span class="line">    --update-delay 10s \</span><br><span class="line">    redis:3.0.6</span><br><span class="line"></span><br><span class="line">      104tlme67z7kewccmznvm39du</span><br><span class="line"></span><br><span class="line">  # --update-delay format is 1h10m30s –– 1 hour 10 minutes and 30 seconds</span><br><span class="line"></span><br><span class="line">// inspect the redis service</span><br><span class="line"></span><br><span class="line">  docker service inspect --pretty redis</span><br><span class="line"></span><br><span class="line">      [...]</span><br><span class="line">      Image:		redis:3.0.6</span><br><span class="line">      [...]</span><br><span class="line"></span><br><span class="line">// update the container image for redis</span><br><span class="line"></span><br><span class="line">  docker service update --image redis:3.0.7 redis</span><br><span class="line"></span><br><span class="line">      redis</span><br><span class="line"></span><br><span class="line">// inspect the redis service</span><br><span class="line"></span><br><span class="line">  docker service inspect --pretty redis</span><br><span class="line"></span><br><span class="line">      [...]</span><br><span class="line">      Image:		redis:3.0.7</span><br><span class="line">      [...]</span><br><span class="line"></span><br><span class="line">  # shows if your update paused due to failure</span><br><span class="line"></span><br><span class="line">// restart paused service if necessary</span><br><span class="line"></span><br><span class="line">  docker service update redis</span><br><span class="line"></span><br><span class="line">      # To avoid repeating certain update failures you may need to pass flags to docker</span><br><span class="line"></span><br><span class="line">// monitor rolling updates</span><br><span class="line"></span><br><span class="line">  docker service ps redis</span><br><span class="line"></span><br><span class="line">      ID                         NAME         IMAGE        NODE      DESIRED STATE  CURRENT STATE           ERROR</span><br><span class="line">      bk1ujjcsnkp8gavbv9kb4e2p5  redis.1      redis:3.0.7  worker2   Running        Running 5 minutes ago</span><br><span class="line">      89xfgslzwdl46169dy75a87vt   \_ redis.1  redis:3.0.6  worker2   Shutdown       Shutdown 5 minutes ago</span><br><span class="line">      2me0n3awwrrvx3hyp1bhlcjyj  redis.2      redis:3.0.7  manager1  Running        Running 5 minutes ago</span><br><span class="line">      ekf32w4ncj2pycofoiio4kxa6   \_ redis.2  redis:3.0.6  worker1   Shutdown       Shutdown 5 minutes ago</span><br><span class="line">      7f41okqfq11fmrhu2u3dajsk1  redis.3      redis:3.0.7  manager1  Running        Running 6 minutes ago</span><br><span class="line">      0i0jbv3brq4yugbcodubhdk6d   \_ redis.3  redis:3.0.6  manager1  Shutdown       Shutdown 6 minutes ago</span><br></pre></td></tr></table></figure>
<h2 id="Drain-the-node"><a href="#Drain-the-node" class="headerlink" title="Drain the node"></a>Drain the node</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">// ssh into manager1</span><br><span class="line"></span><br><span class="line">  docker-machine ssh manager1</span><br><span class="line"></span><br><span class="line">// verify all nodes are available</span><br><span class="line"></span><br><span class="line">  docker node ls</span><br><span class="line"></span><br><span class="line">      ID                           HOSTNAME  STATUS  AVAILABILITY  MANAGER STATUS</span><br><span class="line">      5hfb7vaclplat92apq1ugc40v    worker1   Ready   Active</span><br><span class="line">      b6o6chvidibsnbbqp1ximau36 *  manager1  Ready   Active        Leader</span><br><span class="line">      bx5oreu7adss9zt14it1cv30p    worker2   Ready   Active</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// run redis service if not already running</span><br><span class="line"></span><br><span class="line">  docker service create --replicas 3 --name redis --update-delay 10s redis:3.0.6</span><br><span class="line"></span><br><span class="line">      104tlme67z7k</span><br><span class="line"></span><br><span class="line">// see task assignment</span><br><span class="line"></span><br><span class="line">  docker service ps redis</span><br><span class="line"></span><br><span class="line">      ID                         NAME         IMAGE        NODE      DESIRED STATE  CURRENT STATE            ERROR</span><br><span class="line">      bk1ujjcsnkp8gavbv9kb4e2p5  redis.1      redis:3.0.7  worker2   Running        Running 28 minutes ago</span><br><span class="line">      89xfgslzwdl46169dy75a87vt   \_ redis.1  redis:3.0.6  worker2   Shutdown       Shutdown 28 minutes ago</span><br><span class="line">      2me0n3awwrrvx3hyp1bhlcjyj  redis.2      redis:3.0.7  manager1  Running        Running 28 minutes ago</span><br><span class="line">      ekf32w4ncj2pycofoiio4kxa6   \_ redis.2  redis:3.0.6  worker1   Shutdown       Shutdown 28 minutes ago</span><br><span class="line">      7f41okqfq11fmrhu2u3dajsk1  redis.3      redis:3.0.7  manager1  Running        Running 28 minutes ago</span><br><span class="line">      0i0jbv3brq4yugbcodubhdk6d   \_ redis.3  redis:3.0.6  manager1  Shutdown       Shutdown 29 minutes ago</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// drain worker1 node</span><br><span class="line"></span><br><span class="line">  docker node update --availability drain worker1</span><br><span class="line"></span><br><span class="line">      worker1</span><br><span class="line"></span><br><span class="line">// check node availability</span><br><span class="line"></span><br><span class="line">  docker node inspect --pretty worker1</span><br><span class="line"></span><br><span class="line">      [...]</span><br><span class="line">      Status:</span><br><span class="line">       State:			Ready</span><br><span class="line">       Availability:		Drain</span><br><span class="line">      [...]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// see updated task assignment</span><br><span class="line"></span><br><span class="line">  docker service ps redis</span><br><span class="line"></span><br><span class="line">      ID                         NAME         IMAGE        NODE      DESIRED STATE  CURRENT STATE         ERROR</span><br><span class="line">      bk1ujjcsnkp8gavbv9kb4e2p5  redis.1      redis:3.0.7  worker2   Running        Running 2 hours ago</span><br><span class="line">      89xfgslzwdl46169dy75a87vt   \_ redis.1  redis:3.0.6  worker2   Shutdown       Shutdown 2 hours ago</span><br><span class="line">      2me0n3awwrrvx3hyp1bhlcjyj  redis.2      redis:3.0.7  manager1  Running        Running 2 hours ago</span><br><span class="line">      ekf32w4ncj2pycofoiio4kxa6   \_ redis.2  redis:3.0.6  worker1   Shutdown       Shutdown 2 hours ago</span><br><span class="line">      7f41okqfq11fmrhu2u3dajsk1  redis.3      redis:3.0.7  manager1  Running        Running 2 hours ago</span><br><span class="line">      0i0jbv3brq4yugbcodubhdk6d   \_ redis.3  redis:3.0.6  manager1  Shutdown       Shutdown 2 hours ago</span><br><span class="line"></span><br><span class="line">// return node to active use</span><br><span class="line"></span><br><span class="line">  docker node update --availability active worker1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// check node availability</span><br><span class="line"></span><br><span class="line">  docker node inspect --pretty worker1</span><br><span class="line"></span><br><span class="line">      [...]</span><br><span class="line">      Status:</span><br><span class="line">       State:			Ready</span><br><span class="line">       Availability:		Active</span><br><span class="line">      [...]</span><br></pre></td></tr></table></figure>
<h2 id="Use-swarm-mode-routing-mesh"><a href="#Use-swarm-mode-routing-mesh" class="headerlink" title="Use swarm mode routing mesh"></a>Use swarm mode routing mesh</h2><p>In order to use the ingress network in the swarm, you need to have the following ports open between the swarm nodes before you enable swarm mode:</p>
<ul>
<li>Port 7946 TCP/UDP for container network discovery.</li>
<li>Port 4789 UDP for the container ingress network.</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">// start a serice with published port</span><br><span class="line"></span><br><span class="line">  docker service create \</span><br><span class="line">    --name my-web \</span><br><span class="line">    --publish 5000:80 \</span><br><span class="line">    --replicas 2 \</span><br><span class="line">    nginx</span><br><span class="line"></span><br><span class="line">  # publish port 5000 for the service</span><br><span class="line">  # all nodes listen on port 5000 and route to active containers</span><br><span class="line"></span><br><span class="line">      85h6grnafwiawihekoy4ql20q</span><br><span class="line"></span><br><span class="line">// view the service’s published port</span><br><span class="line"></span><br><span class="line">  docker service inspect --pretty  my-web</span><br><span class="line"></span><br><span class="line">      [...]</span><br><span class="line">      Ports:</span><br><span class="line">       Protocol = tcp</span><br><span class="line">       TargetPort = 80</span><br><span class="line">       PublishedPort = 5000</span><br><span class="line">      [...]</span><br><span class="line"></span><br><span class="line">// remove service and verify removal</span><br><span class="line"></span><br><span class="line">  docker service rm my-web ; docker inspect my-web</span><br><span class="line"></span><br><span class="line">      my-web</span><br><span class="line">      []</span><br><span class="line">      Error: No such image, container or task: my-web</span><br><span class="line"></span><br><span class="line">// start a service without published port</span><br><span class="line"></span><br><span class="line">  docker service create \</span><br><span class="line">    --name my-web \</span><br><span class="line">    --replicas 2 \</span><br><span class="line">    nginx</span><br><span class="line"></span><br><span class="line">      eg082ga5qvvijwi526ubrwx44</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// verify the service has no published port</span><br><span class="line"></span><br><span class="line">  docker service inspect --pretty  my-web</span><br><span class="line"></span><br><span class="line">      [...]</span><br><span class="line">      &lt;no Ports section&gt;</span><br><span class="line">      [...]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// publish a port for an existing service</span><br><span class="line"></span><br><span class="line">  docker service update \</span><br><span class="line">    --publish-add 5000:80 \</span><br><span class="line">    my-web</span><br><span class="line"></span><br><span class="line">// view the service’s published port</span><br><span class="line"></span><br><span class="line">  docker service inspect --pretty  my-web</span><br><span class="line"></span><br><span class="line">      [...]</span><br><span class="line">      Ports:</span><br><span class="line">       Protocol = tcp</span><br><span class="line">       TargetPort = 80</span><br><span class="line">       PublishedPort = 5000</span><br><span class="line">      [...]</span><br><span class="line"></span><br><span class="line">// test the service</span><br><span class="line"></span><br><span class="line">  curl localhost:5000</span><br><span class="line"></span><br><span class="line">    [...]</span><br><span class="line">    &lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class="line">    [...]</span><br></pre></td></tr></table></figure>
<h2 id="Configure-an-external-load-balancer"><a href="#Configure-an-external-load-balancer" class="headerlink" title="Configure an external load balancer"></a>Configure an external load balancer</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">// to be done</span><br></pre></td></tr></table></figure>

                
            </div>
        </article>
    
</div>
<div class="paginator">
    
        
        <a class="prev" href="/page/15/">
            <i class="iconfont icon-prev"></i>
            Prev
        </a>
        
        
        <a class="next" href="/page/17/">
            Next
            <i class="iconfont icon-next"></i>
        </a>
        
    
</div>

    </div>
</div>
<footer class="footer-social">
    
    <a class="social-link" target="_blank" href="https://github.com/dearfrankg">
        <i class="iconfont icon-github"></i>
    </a>
    

    

    

    <div class="footer-copyright">
        <p class="time-line">
            &copy;
            
            
            2018
            &nbsp;<i class="iconfont icon-heart"></i>&nbsp;
            <a target="_blank" href="https://github.com/dearfrankg">Frank Gutierrez</a>
        </p>
    </div>
</footer>
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="/js/index.js"></script>
<!-- <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script> -->
<script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
<script>
    

</script>
</html>
