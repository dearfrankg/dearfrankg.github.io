<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
    <title>dev notes</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/gitment.css">
    <link rel="stylesheet" href="/css/font_859455_eaq7v6w8ktj.css">
</head>

<body>
<header class="header">
    <div class="header-inner">
        <div class="header-title">

        </div>
        <nav class="header-nav">
            
            <a href="/" class="header-nav-link">
                Home
            </a>
            

            
            <a href="/archives" class="header-nav-link">
                Archives
            </a>
            

            
            <a href="/tags" class="header-nav-link">
                Tags
            </a>
            

            
        </nav>
    </div>
</header>
<header class="mobile-header">
    <div class="mobile-nav">
        <div class="mobile-nav-icon">
            <span></span>
            <span></span>
            <span></span>
        </div>
        <div class="mobile-nav-title">
            <a href="/" class="mobile-nav-title-link">Frank Gutierrez's Blog</a>
        </div>

    </div>
    <nav class="mobile-menu">
        <ul class="mobile-menu-list">
            <li class="mobile-menu-item">
                <i class="iconfont icon-home"></i>
                <a href="/" class="mobile-nav-link">Home</a>
            </li>
            <li class="mobile-menu-item">
                <i class="iconfont icon-archive"></i>
                <a href="/archives" class="mobile-nav-link">Archives</a>
            </li>
            <li class="mobile-menu-item">
                <i class="iconfont icon-tag"></i>
                <a href="/tags" class="mobile-nav-link">Tags</a>
            </li>
            <li class="mobile-menu-item">
                <i class="iconfont icon-about"></i>
                <a href="/about/" class="mobile-nav-link">About</a>
            </li>
        </ul>
    </nav>
</header>
<div class="main">
    <div class="content-inner">
        <div class="posts">
    <article class="post-whole">
        <div class="post-title">
            <h2 class="title">server side rendering in react</h2>
            <div class="post-meta">
                <span class="post-time">2018-10-31</span>
                
                <span class="post-visit"> visited：<span id="busuanzi_value_page_pv"></span></span>
            </div>
        </div>
        <div class="post-toc" id="post-toc">
    <strong class="post-toc-title">TOC</strong>
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Intro"><span class="toc-text">Intro</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Basic-SSR"><span class="toc-text">Basic SSR</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Routing"><span class="toc-text">Routing</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#State-Management"><span class="toc-text">State Management</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Fetching-Data"><span class="toc-text">Fetching Data</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Helmet"><span class="toc-text">Helmet</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Conclusion"><span class="toc-text">Conclusion</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#References"><span class="toc-text">References</span></a></li></ol>
    <div class="back-to-top" id="back-to-top">
        <a href="javascript:void(0);">back to top</a>
    </div>
</div>

        <div class="post-content">
            <h2 id="Intro"><a href="#Intro" class="headerlink" title="Intro"></a>Intro</h2><p>Let’s discuss how to build universal applications with React. First some definitions:</p>
<p><strong>Server-Side Rendering (SSR)</strong><br>The ability of a front-end framework to render markup while running on a back-end system.</p>
<p><strong>Single Page Application (SPA)</strong><br>SPA’s have advantages in speed but the initial server request is generally returning an empty HTML file with CSS and JavaScript (JS) links. Then the external files need to be fetched in order for the markup to render. This requires a longer wait for the initial render, and crawlers may interpret your page as empty.</p>
<p><strong>Universal Application</strong><br>Universal Applications have the ability to render both on the server and client. Rendering on the server initially, then leverage SPAs on the client. The user gets fully rendered HTML with the initial request without waiting for JS to load.</p>
<blockquote>
<p>SSR + SPA = Universal App</p>
</blockquote>
<p>Imagine the huge improvement for users navigating on slow 3G networks. Rather than waiting for over 20s for the website to load, you get content on their screen almost instantly.</p>
<p><img src="https://goo.gl/Wd7Bm9" alt=""></p>
<p>The SEO department is happy because the SEO data always rendered, and the Crawlers are happy because they see your site as any other static site and can index the content.</p>
<p>So to recap, the two main benefits we get from SSR are:</p>
<ul>
<li>Faster times for the initial page render</li>
<li>Fully indexable HTML pages</li>
</ul>
<p><strong>Understanding SSR — one step at a time</strong><br>We’ll take an iterative approach to build our complete SSR example. We start with React’s API for server rendering and we’ll add something to the mix at each step. You can follow along using this <a href="https://goo.gl/bVQDWw" target="_blank" rel="noopener">repository</a> and the tags defined there for each step.</p>
<h2 id="Basic-SSR"><a href="#Basic-SSR" class="headerlink" title="Basic SSR"></a>Basic SSR</h2><blockquote>
<p>Checkout the <a href="https://goo.gl/bVQDWw" target="_blank" rel="noopener">repository</a> <code>basic</code> tag to see the working code.</p>
</blockquote>
<ul>
<li>our server serves static files from the output folder</li>
<li>our server has one route that handles all non-static requests and responds with HTML.</li>
<li>our client executes <code>ReactDOM.hydrate</code> will attach event handlers to the server-rendered React app.</li>
</ul>
<figure class="highlight js"><figcaption><span>src/server.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">app.get(<span class="string">"/*"</span>, (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> jsx = <span class="xml"><span class="tag">&lt;<span class="name">Layout</span> /&gt;</span>;</span></span><br><span class="line"><span class="xml">  const reactDom = renderToString(jsx);</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">  res.writeHead(200, &#123; "Content-Type": "text/html" &#125;);</span></span><br><span class="line"><span class="xml">  res.end(htmlTemplate(reactDom));</span></span><br><span class="line"><span class="xml">&#125;);</span></span><br><span class="line"><span class="xml">...</span></span><br></pre></td></tr></table></figure>
<p>On the server we render a string to an HTML template.</p>
<figure class="highlight js"><figcaption><span>src/client.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">ReactDOM.hydrate(<span class="xml"><span class="tag">&lt;<span class="name">Layout</span> /&gt;</span>, app);</span></span><br><span class="line"><span class="xml">...</span></span><br></pre></td></tr></table></figure>
<p>If you call <code>ReactDOM.hydrate()</code> on a node that already has this server-rendered markup, <strong>React will preserve it and only attach event handlers</strong>, allowing you to have a very performant first-load experience.</p>
<figure class="highlight html"><figcaption><span>source from the browser</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">data-reactroot</span>=<span class="string">""</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Welcome to React SSR!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/"</span>&gt;</span>Home<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/about"</span>&gt;</span>About<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/contact"</span>&gt;</span>Contact<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h2</span>&gt;</span>This is the contact page<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"./app.bundle.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>Here we see the fully rendered HTML for the app. I added line breaks for legibility.</p>
<p>You just created your first server-rendered React app!</p>
<h2 id="Routing"><a href="#Routing" class="headerlink" title="Routing"></a>Routing</h2><blockquote>
<p>Checkout the <a href="https://goo.gl/bVQDWw" target="_blank" rel="noopener">repository</a> <code>router</code> tag to see the working code.</p>
</blockquote>
<p>Let’s add a few routes and see how we handle the server part.</p>
<figure class="highlight js"><figcaption><span>src/components/Layout.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">Layout</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">...</span><br><span class="line">  &lt;Switch&gt;</span><br><span class="line">    &lt;Route path=<span class="string">"/"</span> exact component=&#123;Home&#125; /&gt;</span><br><span class="line">    &lt;Route path=<span class="string">"/about"</span> exact component=&#123;About&#125; /&gt;</span><br><span class="line">    &lt;Route path=<span class="string">"/contact"</span> exact component=&#123;Contact&#125; /&gt;</span><br><span class="line">  &lt;<span class="regexp">/Switch&gt;</span></span><br><span class="line"><span class="regexp">...</span></span><br></pre></td></tr></table></figure>
<p>The Layout component now renders multiple routes on the client.</p>
<figure class="highlight js"><figcaption><span>src/components/Layout.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">import</span> &#123; StaticRouter &#125; <span class="keyword">from</span> <span class="string">"react-router-dom"</span>;</span><br><span class="line">...</span><br><span class="line">app.get(<span class="string">"/*"</span>, (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> context = &#123;&#125;;</span><br><span class="line">  <span class="keyword">const</span> jsx = (</span><br><span class="line">    &lt;StaticRouter context=&#123;context&#125; location=&#123;req.url&#125;&gt;</span><br><span class="line">      &lt;Layout /&gt;</span><br><span class="line">    &lt;<span class="regexp">/StaticRouter&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">  const reactDom = renderToString(jsx);</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">  res.writeHead(200, &#123; "Content-Type": "text/</span>html<span class="string">" &#125;);</span></span><br><span class="line"><span class="string">  res.end(htmlTemplate(reactDom));</span></span><br><span class="line"><span class="string">&#125;);</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure>
<p>On the server, we need to wrap our React application in the <code>StaticRouter</code> component and provide the location. As a side note, the <code>context</code> is used for tracking potential redirects while rendering the React DOM. This needs to be handled with a <code>3XX response</code> from the server.</p>
<h2 id="State-Management"><a href="#State-Management" class="headerlink" title="State Management"></a>State Management</h2><blockquote>
<p>Checkout the <a href="https://goo.gl/bVQDWw" target="_blank" rel="noopener">repository</a> <code>redux</code> tag to see the working code.</p>
</blockquote>
<p>In the scenario, when using Redux to handle state management on the client. We sometimes render parts of the DOM based on state, so it makes sense to initialize Redux on the server.</p>
<p>If your app is dispatching actions on the server, it needs to capture the state and send it over the wire together with the HTML. On the client, we feed that initial state into Redux.</p>
<figure class="highlight js"><figcaption><span>src/server.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">import</span> &#123; Provider <span class="keyword">as</span> ReduxProvider &#125; <span class="keyword">from</span> <span class="string">"react-redux"</span>;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">"/*"</span>, (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> context = &#123;&#125;;</span><br><span class="line">  <span class="keyword">const</span> store = createStore();</span><br><span class="line"></span><br><span class="line">  store.dispatch(initializeSession());</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> jsx = (</span><br><span class="line">    &lt;ReduxProvider store=&#123;store&#125;&gt;</span><br><span class="line">      &lt;StaticRouter context=&#123;context&#125; location=&#123;req.url&#125;&gt;</span><br><span class="line">        &lt;Layout /&gt;</span><br><span class="line">      &lt;<span class="regexp">/StaticRouter&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>ReduxProvider&gt;</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">const</span> reactDom = renderToString(jsx);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> reduxState = store.getState();</span><br><span class="line"></span><br><span class="line">  res.writeHead(<span class="number">200</span>, &#123; <span class="string">"Content-Type"</span>: <span class="string">"text/html"</span> &#125;);</span><br><span class="line">  res.end(htmlTemplate(reactDom, reduxState));</span><br><span class="line">&#125;);</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>The HTML template will store the stringified <code>reduxState</code> in <code>window.REDUX_DATA</code></p>
<figure class="highlight js"><figcaption><span>src/client.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> ReactDOM <span class="keyword">from</span> <span class="string">"react-dom"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; BrowserRouter <span class="keyword">as</span> Router &#125; <span class="keyword">from</span> <span class="string">"react-router-dom"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Provider <span class="keyword">as</span> ReduxProvider &#125; <span class="keyword">from</span> <span class="string">"react-redux"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> Layout <span class="keyword">from</span> <span class="string">"./components/Layout"</span>;</span><br><span class="line"><span class="keyword">import</span> createStore <span class="keyword">from</span> <span class="string">"./store"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> store = createStore(<span class="built_in">window</span>.REDUX_DATA);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> jsx = (</span><br><span class="line">  &lt;ReduxProvider store=&#123;store&#125;&gt;</span><br><span class="line">    &lt;Router&gt;</span><br><span class="line">      &lt;Layout /&gt;</span><br><span class="line">    &lt;<span class="regexp">/Router&gt;</span></span><br><span class="line"><span class="regexp">  &lt;/</span>ReduxProvider&gt;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="built_in">document</span>.getElementById(<span class="string">"app"</span>);</span><br><span class="line">ReactDOM.hydrate(jsx, app);</span><br></pre></td></tr></table></figure>
<p>On the client, we initialize the state with state from the server. This process is similar to the DOM hydration.</p>
<h2 id="Fetching-Data"><a href="#Fetching-Data" class="headerlink" title="Fetching Data"></a>Fetching Data</h2><blockquote>
<p>Checkout the <a href="https://goo.gl/bVQDWw" target="_blank" rel="noopener">repository</a> <code>fetch</code> tag to see the working code.</p>
</blockquote>
<p>It a typical SPA the client will fetch data to render and you may see a spinner while the fetch is in progress. This is not a good UX. We don’t need no stinking spinner! To avoid that we will fetch the data from the server.</p>
<p>We will make our API calls from the server and store the data in Redux, then render the HTML with all the relevant data. We need a way to define what data is required for each route so we’ll create a routes config file.</p>
<figure class="highlight js"><figcaption><span>src/routes.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> [</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">"/"</span>,</span><br><span class="line">    component: Home,</span><br><span class="line">    exact: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">"/about"</span>,</span><br><span class="line">    component: About,</span><br><span class="line">    exact: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">"/contact"</span>,</span><br><span class="line">    component: Contact,</span><br><span class="line">    exact: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">"/secret"</span>,</span><br><span class="line">    component: Secret,</span><br><span class="line">    exact: <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<p>The main thing the <code>routes.js</code> file does is map the route to the component.</p>
<figure class="highlight js"><figcaption><span>home.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">import</span> &#123; fetchData &#125; <span class="keyword">from</span> <span class="string">"../store"</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Home</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line">Home.serverFetch = fetchData; <span class="comment">// static declaration of data requirements</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>In <code>home.js</code> above we create a <code>serverFetch</code> class property that will be mapped to a Redux thunk action responsible for fetching all the data required for the component. For each route there should be a matching component that might need data. If it does it should have a <code>serverFetch</code> property that fetches all the data required for the component. Remember that Redux thunk actions return a promise when dispatched.</p>
<figure class="highlight js"><figcaption><span>src/server.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">import</span> &#123; StaticRouter, matchPath &#125; <span class="keyword">from</span> <span class="string">"react-router-dom"</span>;</span><br><span class="line"><span class="keyword">import</span> routes <span class="keyword">from</span> <span class="string">"./routes"</span>;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">"/*"</span>, (req, res) =&gt; &#123;</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> dataRequirements = routes</span><br><span class="line">    .filter(<span class="function"><span class="params">route</span> =&gt;</span> matchPath(req.url, route)) <span class="comment">// filter matching paths</span></span><br><span class="line">    .map(<span class="function"><span class="params">route</span> =&gt;</span> route.component) <span class="comment">// map to components</span></span><br><span class="line">    .filter(<span class="function"><span class="params">comp</span> =&gt;</span> comp.serverFetch) <span class="comment">// check if components have data requirement</span></span><br><span class="line">    .map(<span class="function"><span class="params">comp</span> =&gt;</span> store.dispatch(comp.serverFetch())); <span class="comment">// dispatch data requirement</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">Promise</span>.all(dataRequirements).then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> jsx = (</span><br><span class="line">      &lt;ReduxProvider store=&#123;store&#125;&gt;</span><br><span class="line">        &lt;StaticRouter context=&#123;context&#125; location=&#123;req.url&#125;&gt;</span><br><span class="line">          &lt;Layout /&gt;</span><br><span class="line">        &lt;<span class="regexp">/StaticRouter&gt;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>ReduxProvider&gt;</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">const</span> reactDom = renderToString(jsx);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> reduxState = store.getState();</span><br><span class="line"></span><br><span class="line">    res.writeHead(<span class="number">200</span>, &#123; <span class="string">"Content-Type"</span>: <span class="string">"text/html"</span> &#125;);</span><br><span class="line">    res.end(htmlTemplate(reactDom, reduxState));</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>The <code>routes.js</code> includes a list of components that will be rendered for the current URL. We fetch any required data in parallel and wait for them to complete. Finally we resume the server render with all the data in Redux.</p>
<p>You probably notice that this comes with a performance penalty, because we’re delaying the render until the data is fetched. This is where you start comparing metrics and do your best to understand which calls are essential and which aren’t. For example, fetching products for an e-commerce app might be crucial, but prices and sidebar filters can be lazy loaded.</p>
<h2 id="Helmet"><a href="#Helmet" class="headerlink" title="Helmet"></a>Helmet</h2><blockquote>
<p>Checkout the <a href="https://goo.gl/bVQDWw" target="_blank" rel="noopener">repository</a> <code>helmet</code> tag to see the working code.</p>
</blockquote>
<p><a href="https://github.com/nfl/react-helmet" target="_blank" rel="noopener">react-helmet</a> has great support for SSR and allows us to set values in our <code>&lt;head&gt;</code> tag. For example, you may want to set the <em>SEO data</em>, <em>title, meta tags, keywords</em>, and so on.</p>
<p>Keep in mind that the <code>&lt;head&gt;</code> tag is normally not part of your React app!</p>
<figure class="highlight js"><figcaption><span>contact.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> Helmet <span class="keyword">from</span> <span class="string">"react-helmet"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Contact = <span class="function"><span class="params">()</span> =&gt;</span> (</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;h2&gt;This is the contact page&lt;<span class="regexp">/h2&gt;</span></span><br><span class="line"><span class="regexp">    &lt;Helmet&gt;</span></span><br><span class="line"><span class="regexp">      &lt;title&gt;Contact Page&lt;/</span>title&gt;</span><br><span class="line">      &lt;meta name=<span class="string">"description"</span> content=<span class="string">"This is a proof of concept for React SSR"</span> /&gt;</span><br><span class="line">    &lt;<span class="regexp">/Helmet&gt;</span></span><br><span class="line"><span class="regexp">  &lt;/</span>div&gt;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Contact;</span><br></pre></td></tr></table></figure>
<p>Just add your <code>head</code> data as children inside your <code>&lt;Helmet&gt;</code> tags. This gives you support for changing values outside the mounted React app on the client.</p>
<figure class="highlight js"><figcaption><span>src/server.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">import</span> Helmet <span class="keyword">from</span> <span class="string">"react-helmet"</span>;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">app.get( <span class="string">"/*"</span>, ( req, res ) =&gt; &#123;</span><br><span class="line">    ...</span><br><span class="line">        <span class="keyword">const</span> jsx = (</span><br><span class="line">            &lt;ReduxProvider store=&#123; store &#125;&gt;</span><br><span class="line">                &lt;StaticRouter context=&#123; context &#125; location=&#123; req.url &#125;&gt;</span><br><span class="line">                    &lt;Layout /&gt;</span><br><span class="line">                &lt;<span class="regexp">/StaticRouter&gt;</span></span><br><span class="line"><span class="regexp">            &lt;/</span>ReduxProvider&gt;</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">const</span> reactDom = renderToString( jsx );</span><br><span class="line">        <span class="keyword">const</span> reduxState = store.getState( );</span><br><span class="line">        <span class="keyword">const</span> helmetData = Helmet.renderStatic( );</span><br><span class="line"></span><br><span class="line">        res.writeHead( <span class="number">200</span>, &#123; <span class="string">"Content-Type"</span>: <span class="string">"text/html"</span> &#125; );</span><br><span class="line">        res.end( htmlTemplate( reactDom, reduxState, helmetData ) );</span><br><span class="line">    &#125; );</span><br><span class="line">&#125; );</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">htmlTemplate</span>(<span class="params"> reactDom, reduxState, helmetData </span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`</span></span><br><span class="line"><span class="string">        &lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="string">        &lt;html&gt;</span></span><br><span class="line"><span class="string">        &lt;head&gt;</span></span><br><span class="line"><span class="string">            &lt;meta charset="utf-8"&gt;</span></span><br><span class="line"><span class="string">            <span class="subst">$&#123; helmetData.title.toString( ) &#125;</span></span></span><br><span class="line"><span class="string">            <span class="subst">$&#123; helmetData.meta.toString( ) &#125;</span></span></span><br><span class="line"><span class="string">            &lt;title&gt;React SSR&lt;/title&gt;</span></span><br><span class="line"><span class="string">        &lt;/head&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        ...</span></span><br><span class="line"><span class="string">            `</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Here is Helmet extracting the head data and rendering it inside the HTML template.</p>
<p>And now we have a fully functional React SSR example!</p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><blockquote>
<p>Checkout the <a href="https://goo.gl/bVQDWw" target="_blank" rel="noopener">repository</a> <code>master</code> branch for the final version.</p>
</blockquote>
<p>What have we accomplished using SSR:</p>
<ul>
<li>We added basic SSR which allows rendering for a faster first render and indexing for the Crawler.</li>
<li>We added routing which allows the server to render different routes.</li>
<li>We added state management which allows the server to render conditional markup.</li>
<li>We added fetching data which allows the server to fetch data preventing the spinner.</li>
<li>We added Helmet which allows making dynamic changes to the <code>&lt;head&gt;</code>.</li>
</ul>
<p>Is it worth adding SSR to your application? As always, it depends. It’s a must if your website is public and accessible to hundreds of thousands of users. But if you’re building a tool/dashboard-like application it might not be worth the effort.</p>
<p>However, leveraging the power of universal apps is a step forward for the front-end community.</p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ul>
<li><a href="https://goo.gl/VGKPcK" target="_blank" rel="noopener">Demystifying server-side rendering in React</a></li>
</ul>

        </div>
        
        <div class="post-tag">
            
            <a class="tag" href="/tags/reactjs/" title="reactjs">reactjs</a>
            
            <a class="tag" href="/tags/SSR/" title="SSR">SSR</a>
            
        </div>
        
    </article>
</div>
<div class="paginator">
    
        
            <a class="prev" href="/2018/11/03/20181101-securing-your-web-app/">
                <i class="iconfont icon-prev"></i>
                <span class="nav-default">securing your web app</span>
                <span class="nav-mobile">Prev</span>
            </a>
        
        
            <a class="next" href="/2018/10/31/20181031-intro-to-next-part1/">
                <span class="nav-default">intro to next.js part1</span>
                <span class="nav-mobile">Next</span>
                <i class="iconfont icon-next"></i>
            </a>
        
    
</div>
<div id="comment-container"></div>
    </div>
</div>
<footer class="footer-social">
    
    <a class="social-link" target="_blank" href="https://github.com/dearfrankg">
        <i class="iconfont icon-github"></i>
    </a>
    

    

    

    <div class="footer-copyright">
        <p class="time-line">
            &copy;
            
            
            2018
            &nbsp;<i class="iconfont icon-heart"></i>&nbsp;
            <a target="_blank" href="https://github.com/dearfrankg">Frank Gutierrez</a>
        </p>
    </div>
</footer>
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="/js/index.js"></script>
<!-- <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script> -->
<script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
<script>
    

</script>
</html>
